<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polite Coaching Centre - Complete Exam System</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e67e22;
            --success: #27ae60;
            --danger: #e74c3c;
            --light: #f8f9fa;
            --dark: #343a40;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
            overflow: hidden;
            position: relative;
        }
        header {
            background: var(--primary);
            color: white;
            padding: 25px 30px;
            text-align: center;
            position: relative;
        }
        header h1 {
            font-size: 1.8rem;
            letter-spacing: 1px;
        }
        .logo {
            font-weight: bold;
            font-size: 2.2rem;
            margin-bottom: 8px;
            color: #f1c40f;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .subtitle {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        .content {
            padding: 30px;
        }
        .screen {
            display: none;
        }
        .screen.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        input, select, textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--secondary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        button {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 14px 25px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
        }
        button:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(52, 152, 219, 0.4);
        }
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .admin-btn {
            background: var(--accent);
            box-shadow: 0 4px 10px rgba(230, 126, 34, 0.3);
        }
        .admin-btn:hover {
            background: #d35400;
            box-shadow: 0 6px 15px rgba(230, 126, 34, 0.4);
        }
        .success-btn {
            background: var(--success);
            box-shadow: 0 4px 10px rgba(39, 174, 96, 0.3);
        }
        .success-btn:hover {
            background: #219653;
            box-shadow: 0 6px 15px rgba(39, 174, 96, 0.4);
        }
        .ai-btn {
            background: #9b59b6;
            box-shadow: 0 4px 10px rgba(155, 89, 182, 0.3);
        }
        .ai-btn:hover {
            background: #8e44ad;
            box-shadow: 0 6px 15px rgba(155, 89, 182, 0.4);
        }
        .upload-btn {
            background: #1abc9c;
            box-shadow: 0 4px 10px rgba(26, 188, 156, 0.3);
        }
        .upload-btn:hover {
            background: #16a085;
            box-shadow: 0 6px 15px rgba(26, 188, 156, 0.4);
        }
        .error {
            color: var(--danger);
            margin-top: 10px;
            font-weight: 500;
            text-align: center;
        }
        .success {
            color: var(--success);
            margin-top: 10px;
            font-weight: 500;
            text-align: center;
        }
        .timer {
            background: var(--danger);
            color: white;
            text-align: center;
            padding: 12px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.3rem;
            margin-bottom: 25px;
            box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
        }
        .question-container {
            background: var(--light);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        .question-number {
            font-size: 1.1rem;
            color: var(--secondary);
            margin-bottom: 10px;
            font-weight: 600;
        }
        .question-text {
            font-size: 1.4rem;
            margin-bottom: 25px;
            line-height: 1.5;
            color: var(--dark);
        }
        .options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .option {
            padding: 15px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
        }
        .option:hover {
            border-color: var(--secondary);
            transform: translateX(5px);
        }
        .option.selected {
            background: rgba(52, 152, 219, 0.1);
            border-color: var(--secondary);
            font-weight: 600;
        }
        .option-letter {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: var(--secondary);
            color: white;
            border-radius: 50%;
            margin-right: 15px;
            font-weight: bold;
            flex-shrink: 0;
        }
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .progress {
            text-align: center;
            font-weight: 600;
            color: var(--primary);
            font-size: 1.2rem;
            margin: 15px 0;
        }
        .result-container {
            text-align: center;
            padding: 40px 20px;
        }
        .score-display {
            font-size: 3.5rem;
            font-weight: bold;
            color: var(--accent);
            margin: 20px 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .expiry-warning {
            background: #fff8e1;
            border-left: 4px solid var(--accent);
            padding: 15px;
            border-radius: 0 8px 8px 0;
            margin: 15px 0;
            font-weight: 500;
        }
        .hidden {
            display: none;
        }
        .question-tag {
            display: inline-block;
            background: #e1f0fa;
            color: var(--secondary);
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
            margin-bottom: 10px;
            font-weight: 500;
        }
        .system-status {
            background: #e8f5e9;
            border-radius: 12px;
            padding: 20px;
            margin: 25px 0;
            border-left: 4px solid var(--success);
        }
        .system-status h3 {
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .status-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            border: 2px solid var(--success);
        }
        .status-item.status-bad {
            border-color: var(--danger);
        }
        .status-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }
        .status-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        .feature-section {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
            border-left: 4px solid var(--accent);
        }
        .feature-section h3 {
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        .ai-prompt {
            background: #f1f8ff;
            border: 1px dashed var(--secondary);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        .camera-container {
            position: relative;
            width: 100%;
            margin: 20px 0;
        }
        #camera-preview {
            width: 100%;
            border: 2px solid var(--primary);
            border-radius: 10px;
            background: #f8f9fa;
            display: none;
        }
        .camera-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .camera-btn {
            flex: 1;
            background: var(--primary);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-weight: 500;
        }
        .camera-btn:hover {
            background: #1a252f;
        }
        .camera-btn:disabled {
            background: #bdc3c7;
        }
        .camera-icon {
            font-size: 24px;
            display: inline-block;
            margin-right: 8px;
        }
        .capture-btn {
            background: var(--success);
            display: none;
        }
        
        /* Notification System */
        .notification-container {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            z-index: 1000;
            pointer-events: none;
        }
        .notification {
            background: white;
            border-radius: 10px;
            padding: 15px 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            margin: 10px;
            pointer-events: all;
            animation: slideIn 0.3s forwards, fadeOut 0.3s 2.7s forwards;
            max-width: 80%;
            text-align: center;
            font-weight: 500;
        }
        .notification.success {
            background: linear-gradient(to right, var(--success), #2ecc71);
            color: white;
        }
        .notification.error {
            background: linear-gradient(to right, var(--danger), #c0392b);
            color: white;
        }
        .notification.info {
            background: linear-gradient(to right, var(--primary), #3498db);
            color: white;
        }
        @keyframes slideIn {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(20px);
            }
        }
        
        @media (max-width: 600px) {
            .content {
                padding: 20px;
            }
            header {
                padding: 20px;
            }
            header h1 {
                font-size: 1.5rem;
            }
            .logo {
                font-size: 1.8rem;
            }
            .question-text {
                font-size: 1.2rem;
            }
            .option {
                padding: 12px;
                font-size: 1rem;
            }
            .navigation button {
                padding: 10px 15px;
                font-size: 16px;
            }
        }

        /* Hero Landing Page Styles */
        .hero-section {
            text-align: center;
            padding: 60px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin: -30px -30px 30px -30px;
            border-radius: 0 0 30px 30px;
        }
        .hero-title {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 20px;
            text-shadow: 0 4px 8px rgba(0,0,0,0.2);
            animation: slideDown 0.6s ease-out;
        }
        .hero-subtitle {
            font-size: 1.3rem;
            margin-bottom: 40px;
            opacity: 0.95;
        }
        .hero-cta {
            font-size: 1.5rem !important;
            padding: 22px 50px !important;
            background: #f1c40f !important;
            color: #2c3e50 !important;
            border-radius: 50px !important;
            box-shadow: 0 8px 20px rgba(241, 196, 15, 0.4) !important;
            font-weight: 700 !important;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 20px auto;
            width: auto !important;
            display: inline-block;
        }
        .hero-cta:hover {
            background: #f39c12 !important;
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 12px 30px rgba(241, 196, 15, 0.5) !important;
        }
        .auth-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        .auth-btn {
            padding: 12px 35px !important;
            border-radius: 25px !important;
            width: auto !important;
            font-size: 1.1rem !important;
            background: rgba(255,255,255,0.2) !important;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.3);
        }
        .auth-btn:hover {
            background: rgba(255,255,255,0.3) !important;
            border-color: rgba(255,255,255,0.5);
        }
        .admin-link {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            text-decoration: none;
            padding: 8px 20px;
            border: 2px solid rgba(255,255,255,0.4);
            border-radius: 20px;
            font-weight: 600;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.1);
        }
        .admin-link:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.6);
            transform: translateY(-2px);
        }
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Auth Form Styles */
        .auth-form {
            max-width: 450px;
            margin: 0 auto;
        }
        .form-title {
            text-align: center;
            color: var(--primary);
            margin-bottom: 30px;
            font-size: 2rem;
        }
        .form-link {
            text-align: center;
            margin-top: 20px;
            color: var(--secondary);
        }
        .form-link a {
            color: var(--secondary);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }
        .form-link a:hover {
            text-decoration: underline;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: var(--secondary);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }
        .back-link:hover {
            text-decoration: underline;
        }

        /* Dashboard Styles */
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            position: relative;
        }
        .dashboard-title {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        .dashboard-info {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        .logout-link {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            text-decoration: none;
            padding: 8px 20px;
            border: 2px solid rgba(255,255,255,0.4);
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            background: rgba(255,255,255,0.1);
        }
        .logout-link:hover {
            background: rgba(255,255,255,0.2);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px;
            border-radius: 15px;
            color: white;
            text-align: center;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.95rem;
            opacity: 0.9;
        }
        .exam-history-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        .exam-history-card:hover {
            border-color: var(--secondary);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .exam-card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 10px;
        }
        .exam-card-details {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }
        .exam-card-score {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--success);
        }
        .exam-card-date {
            color: #666;
            font-size: 0.9rem;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
    </style>
    <script src="api-integration.js"></script>
</head>
<body>
    <div class="container">
        <header style="position: relative;">
            <a href="#" id="admin-link" class="admin-link">Admin Login</a>
            <div class="logo">POLITE COACHING CENTRE</div>
            <div class="subtitle">Reasoning, Math & GK Tests for Job Aspirants</div>
        </header>

        <div class="content">
            <!-- Hero Landing Page -->
            <div id="hero-landing" class="screen active">
                <div class="hero-section">
                    <h1 class="hero-title">üéì Excel in Your Exams!</h1>
                    <p class="hero-subtitle">Master Reasoning, Math & General Knowledge for competitive exams</p>
                    <button id="start-exam-hero-btn" class="hero-cta">Let's Go! Take an Exam</button>
                    <div class="auth-buttons">
                        <button id="signin-btn" class="auth-btn">Sign In</button>
                        <button id="signup-btn" class="auth-btn">Create Account</button>
                    </div>
                </div>
            </div>

            <!-- Candidate Signup Screen -->
            <div id="candidate-signup-screen" class="screen">
                <a href="#" id="back-to-hero-from-signup" class="back-link">‚Üê Back</a>
                <div class="auth-form">
                    <h2 class="form-title">Create Your Account</h2>
                    <div class="form-group">
                        <label for="signup-name">Full Name *</label>
                        <input type="text" id="signup-name" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-email">Email Address *</label>
                        <input type="email" id="signup-email" placeholder="your@email.com" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-mobile">Mobile Number *</label>
                        <input type="tel" id="signup-mobile" placeholder="10-digit mobile number" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-password">Password *</label>
                        <input type="password" id="signup-password" placeholder="Create a strong password" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-confirm-password">Confirm Password *</label>
                        <input type="password" id="signup-confirm-password" placeholder="Re-enter your password" required>
                    </div>
                    <button id="signup-submit-btn" class="success-btn">Create Account</button>
                    <div class="form-link">
                        Already have an account? <a id="goto-signin-link">Sign In</a>
                    </div>
                </div>
            </div>

            <!-- Candidate Login Screen -->
            <div id="candidate-signin-screen" class="screen">
                <a href="#" id="back-to-hero-from-signin" class="back-link">‚Üê Back</a>
                <div class="auth-form">
                    <h2 class="form-title">Welcome Back!</h2>
                    <div class="form-group">
                        <label for="signin-email">Email Address *</label>
                        <input type="email" id="signin-email" placeholder="your@email.com" required>
                    </div>
                    <div class="form-group">
                        <label for="signin-password">Password *</label>
                        <input type="password" id="signin-password" placeholder="Enter your password" required>
                    </div>
                    <button id="signin-submit-btn">Sign In</button>
                    <div class="form-link">
                        <a id="forgot-password-link">Forgot Password?</a>
                    </div>
                    <div class="form-link">
                        Don't have an account? <a id="goto-signup-link">Create Account</a>
                    </div>
                </div>
            </div>

            <!-- Forgot Password Screen -->
            <div id="forgot-password-screen" class="screen">
                <a href="#" id="back-to-signin-from-forgot" class="back-link">‚Üê Back to Sign In</a>
                <div class="auth-form">
                    <h2 class="form-title">Reset Your Password</h2>
                    <p style="text-align: center; color: #666; margin-bottom: 25px;">
                        Enter your email address and we'll generate a new temporary password for you.
                    </p>
                    <div class="form-group">
                        <label for="forgot-email">Email Address *</label>
                        <input type="email" id="forgot-email" placeholder="your@email.com" required>
                    </div>
                    <button id="reset-password-btn" class="success-btn">Reset Password</button>
                    <div id="reset-result" style="display: none; margin-top: 20px; padding: 20px; background: #e8f5e9; border-radius: 10px; border-left: 4px solid #27ae60;">
                        <p style="font-weight: 600; color: #27ae60; margin-bottom: 10px;">‚úÖ Password Reset Successful!</p>
                        <p style="color: #666; margin-bottom: 10px;">Your new temporary password is:</p>
                        <div style="background: white; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 1.2rem; font-weight: 700; color: #2c3e50; text-align: center; letter-spacing: 2px;" id="new-temp-password"></div>
                        <p style="color: #666; margin-top: 15px; font-size: 0.9rem;">
                            Please save this password and use it to sign in. We recommend changing it after logging in.
                        </p>
                        <button id="goto-signin-after-reset" style="margin-top: 15px; background: var(--success);">Go to Sign In</button>
                    </div>
                </div>
            </div>

            <!-- Candidate Dashboard -->
            <div id="candidate-dashboard" class="screen">
                <div class="dashboard-header">
                    <a href="#" id="candidate-logout-link" class="logout-link">Logout</a>
                    <h2 class="dashboard-title">Welcome, <span id="dashboard-name"></span>!</h2>
                    <p class="dashboard-info"><span id="dashboard-email"></span> | <span id="dashboard-mobile"></span></p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-exams-given">0</div>
                        <div class="stat-label">Exams Taken</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="average-score">0</div>
                        <div class="stat-label">Average Score</div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <button id="take-exam-dashboard-btn" class="success-btn">Take a New Exam</button>
                </div>

                <h3 style="color: var(--primary); margin-bottom: 20px;">Your Exam History</h3>
                <div id="exam-history-container">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <p>No exams taken yet. Start your first exam!</p>
                    </div>
                </div>
            </div>

            <!-- Admin Login Screen -->
            <div id="admin-login-screen" class="screen">
                <a href="#" id="back-to-hero-from-admin" class="back-link">‚Üê Back</a>
                <div class="auth-form">
                    <h2 class="form-title">Admin Access</h2>
                    <div class="form-group">
                        <label for="admin-username">Username</label>
                        <input type="text" id="admin-username" placeholder="Enter admin username">
                    </div>
                    <div class="form-group">
                        <label for="admin-password">Password</label>
                        <input type="password" id="admin-password" placeholder="Enter admin password">
                    </div>
                    <button id="admin-login-btn" class="admin-btn">Login to Admin Panel</button>
                    <p class="error" id="admin-login-error"></p>
                </div>
            </div>

            <!-- Admin Panel -->
            <div id="admin-panel" class="screen">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 style="color: var(--primary);">Admin Dashboard</h2>
                    <button style="width: auto; padding: 8px 15px; background: var(--danger);" id="logout-btn">Logout</button>
                </div>
                
                <!-- System Status - Actual Information -->
                <div class="system-status">
                    <h3>üìä System Status</h3>
                    <div class="status-grid">
                        <div class="status-item" id="db-status-item">
                            <div class="status-icon">‚òÅÔ∏è</div>
                            <div class="status-title">Airtable Database</div>
                            <div class="status-text" id="db-status-text">‚úÖ Connected</div>
                        </div>
                        <div class="status-item" id="gemini-status-item">
                            <div class="status-icon">ü§ñ</div>
                            <div class="status-title">Gemini AI</div>
                            <div class="status-text" id="gemini-status-text">‚úÖ Active</div>
                        </div>
                        <div class="status-item" id="ocr-status-item">
                            <div class="status-icon">üì∏</div>
                            <div class="status-title">OCR Service</div>
                            <div class="status-text" id="ocr-status-text">‚úÖ Ready</div>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 30px;">
                    <button class="admin-btn" id="question-bank-btn">üìö Question Bank</button>
                    <button class="admin-btn" id="create-exam-btn">‚úèÔ∏è Create New Exam</button>
                    <button class="admin-btn" id="view-results-btn">üìä View Results</button>
                    <button class="upload-btn" id="upload-btn">üì∏ Upload Question Paper</button>
                    <button class="ai-btn" id="ai-btn">ü§ñ AI Question Generator</button>
                </div>


                <!-- Question Bank Section -->
                <div id="question-bank-section" class="hidden">
                    <h3 style="margin: 0 0 15px 0; color: var(--secondary);">Question Bank</h3>

                    <!-- Action Buttons Row -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button id="select-all-questions-btn" style="background: #3498db; color: white; padding: 6px 12px; font-size: 0.8rem; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                                ‚òëÔ∏è Select All
                            </button>
                            <button id="deselect-all-questions-btn" style="background: #95a5a6; color: white; padding: 6px 12px; font-size: 0.8rem; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                                ‚òê Deselect All
                            </button>
                            <button id="export-questions-btn" style="background: #27ae60; color: white; padding: 6px 12px; font-size: 0.8rem; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                                üì• Export CSV
                            </button>
                        </div>
                        <button id="toggle-add-question-btn" style="background: var(--success); padding: 8px 16px; font-size: 0.9rem; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
                            ‚ûï Add New Question
                        </button>
                    </div>

                    <!-- Add Question Form (Initially Hidden) -->
                    <div id="add-question-form" class="hidden" style="background: #f0f8ff; padding: 20px; border-radius: 10px; margin-bottom: 25px; border: 2px solid var(--primary);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: var(--primary);">Add New Question</h4>
                            <button id="close-add-question-btn" style="background: #e74c3c; color: white; padding: 5px 12px; border-radius: 5px; border: none; cursor: pointer; font-size: 0.85rem;">‚úñ Close</button>
                        </div>

                        <div class="form-group">
                            <label>Subject</label>
                            <select id="question-subject">
                                <option value="Math">Math</option>
                                <option value="Reasoning">Reasoning</option>
                                <option value="GK">GK</option>
                                <option value="Others">Others</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Question Text</label>
                            <textarea id="question-text" rows="3" placeholder="Enter the question here..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Option A</label>
                            <input type="text" id="option-a" placeholder="Option A">
                        </div>
                        <div class="form-group">
                            <label>Option B</label>
                            <input type="text" id="option-b" placeholder="Option B">
                        </div>
                        <div class="form-group">
                            <label>Option C</label>
                            <input type="text" id="option-c" placeholder="Option C">
                        </div>
                        <div class="form-group">
                            <label>Option D</label>
                            <input type="text" id="option-d" placeholder="Option D">
                        </div>
                        <div class="form-group">
                            <label>Correct Answer</label>
                            <select id="correct-answer">
                                <option value="0">A</option>
                                <option value="1">B</option>
                                <option value="2">C</option>
                                <option value="3">D</option>
                            </select>
                        </div>
                        <button id="add-question-btn">Add Question to Bank</button>
                        <div class="error" id="question-error"></div>
                        <div class="success" id="question-success"></div>
                    </div>

                    <!-- Existing Questions List -->
                    <div>
                        <h4 style="margin: 20px 0 15px; color: var(--secondary);">Existing Questions</h4>
                        <div id="questions-list">
                            <p style="text-align: center; color: #7f8c8d;">Loading questions from database...</p>
                        </div>
                    </div>
                </div>

                <!-- Create Exam Section -->
                <div id="create-exam-section" class="hidden">
                    <h3 style="margin-bottom: 15px; color: var(--secondary);">New Exam Setup</h3>
                    <div class="form-group">
                        <label>Exam Code (Unique)</label>
                        <input type="text" id="exam-code" placeholder="e.g., REASONING_JULY_01" value="SAMPLE01">
                    </div>
                    <div class="form-group">
                        <label>Exam Title</label>
                        <input type="text" id="exam-title" placeholder="e.g., Logical Reasoning Test for Banking" value="Sample Exam">
                    </div>
                    <div class="form-group">
                        <label>Duration (Minutes)</label>
                        <input type="number" id="exam-duration" min="5" value="10" placeholder="e.g., 60">
                    </div>
                    <div class="form-group">
                        <label>Expiry Date (IST)</label>
                        <input type="date" id="exam-expiry">
                    </div>
                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px;">
                            <label style="margin: 0; color: white; font-size: 1.1rem; font-weight: 600;">Select Questions for Exam</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 8px;">
                                    <input type="number" id="random-count" min="1" value="5" placeholder="#" style="width: 60px; padding: 5px; border: none; border-radius: 5px; text-align: center; font-weight: 600;">
                                    <button id="random-select-btn" style="background: #f39c12; color: white; padding: 6px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; white-space: nowrap;">
                                        üé≤ Random
                                    </button>
                                </div>
                                <div id="selected-count" style="background: white; color: #667eea; padding: 8px 20px; border-radius: 25px; font-weight: 700; font-size: 1.1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.2); min-width: 120px; text-align: center;">
                                    0 Selected
                                </div>
                            </div>
                        </div>
                        <div id="exam-questions-list">
                            <p style="text-align: center; color: #7f8c8d;">Loading questions from database...</p>
                        </div>
                    </div>
                    <button id="create-exam-submit-btn">Create Exam</button>
                    <div class="error" id="exam-error"></div>
                    <div class="success" id="exam-success"></div>
                </div>

                <!-- View Results Section -->
                <div id="view-results-section" class="hidden">
                    <h3 style="margin-bottom: 15px; color: var(--secondary);">Exam Results</h3>
                    <div class="form-group">
                        <label>Select Exam</label>
                        <select id="results-exam-select">
                            <option value="">-- Select Exam --</option>
                            <option value="SAMPLE01">SAMPLE01 - Sample Exam</option>
                        </select>
                    </div>
                    <div id="results-container">
                        <p style="text-align: center; color: #7f8c8d;">Select an exam to view results.</p>
                    </div>
                </div>

                <!-- Upload Question Paper Section -->
                <div id="upload-section" class="hidden">
                    <h3>üì∏ Upload Question Paper</h3>
                    <p>Capture questions directly with your camera or upload an existing image/PDF!</p>

                    <div style="display: flex; gap: 15px; margin: 20px 0; flex-wrap: wrap;">
                        <button class="upload-btn" id="capture-photo-btn" style="flex: 1; min-width: 200px;">
                            üì∑ Capture with Camera
                        </button>
                        <button class="admin-btn" id="choose-file-btn" style="flex: 1; min-width: 200px;">
                            üìÅ Choose from Files
                        </button>
                    </div>

                    <div class="form-group" style="margin-top: 10px;">
                        <input type="file" id="paper-upload" accept="image/*,.pdf" capture="environment" style="display: none;">
                        <input type="file" id="paper-upload-file" accept="image/*,.pdf" style="display: none;">
                        <div id="selected-file-info" class="hidden" style="padding: 12px; background: #e8f5e9; border-radius: 8px; margin-top: 10px;">
                            <strong>Selected:</strong> <span id="file-name"></span>
                        </div>
                    </div>

                    <button class="upload-btn" id="process-upload-btn">ü§ñ Extract Questions with Gemini AI</button>
                    <div id="ocr-progress" class="hidden" style="margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 8px; text-align: center;">
                        <p style="color: var(--secondary); font-weight: 600; margin-bottom: 10px;">Processing with Gemini AI...</p>
                        <div style="background: #ddd; border-radius: 10px; overflow: hidden; height: 20px;">
                            <div id="ocr-progress-bar" style="background: var(--secondary); height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <p id="ocr-status" style="margin-top: 10px; font-size: 0.9rem; color: #666;"></p>
                    </div>
                    
                    <div id="upload-result-container" class="hidden" style="margin-top: 25px; padding: 20px; background: white; border-radius: 12px; border: 1px solid #e0e0e0;">
                        <h4 style="color: var(--primary); margin-bottom: 15px;">Extracted Text</h4>
                        <textarea id="extracted-text" rows="10" style="font-family: monospace; margin-bottom: 20px; resize: vertical;"></textarea>
                        
                        <button class="admin-btn" style="margin-bottom: 15px;" id="clean-text-btn">üßπ Clean & Format Text</button>
                        
                        <h4 style="margin: 20px 0 15px; color: var(--secondary);">Ready to Add Questions</h4>
                        <div id="ready-questions">
                            <p style="text-align: center; color: #7f8c8d;">Click 'Clean & Format Text' to see questions</p>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                            <button class="success-btn" id="add-extracted-btn">‚úÖ Add All Questions to Bank</button>
                            <button class="admin-btn" id="add-selected-btn">‚ûï Add Selected Questions</button>
                        </div>
                    </div>
                </div>

                <!-- AI Question Generator Section -->
                <div id="ai-generator-section" class="hidden">
                    <h3>ü§ñ AI Question Generator</h3>
                    <p>Create high-quality MCQs in seconds with AI. Perfect for job aspirants!</p>

                    <div class="form-group" style="margin-top: 20px;">
                        <label>Subject Category</label>
                        <select id="ai-subject">
                            <option value="Math">Math</option>
                            <option value="Reasoning">Reasoning</option>
                            <option value="GK">General Knowledge (GK)</option>
                            <option value="English">English</option>
                            <option value="Science">Science</option>
                            <option value="History">History</option>
                            <option value="Geography">Geography</option>
                            <option value="Computer">Computer & IT</option>
                            <option value="Others">Others</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Difficulty Level</label>
                        <select id="ai-difficulty">
                            <option value="easy">Easy</option>
                            <option value="medium" selected>Medium</option>
                            <option value="hard">Hard</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Custom Prompt (Optional)</label>
                        <textarea id="ai-custom-prompt" rows="3" placeholder="Example: Generate 5 questions for upcoming Railway Clerk exam focusing on quantitative aptitude&#10;OR: Generate 10 questions for Banking official recruitment exam on current affairs&#10;&#10;Leave empty to auto-generate based on subject and difficulty"></textarea>
                        <p style="font-size: 0.85rem; color: #7f8c8d; margin-top: 5px;">üí° Add specific instructions like exam type (Railway, Banking, SSC), topic focus, or question count</p>
                    </div>

                    <button class="ai-btn" id="generate-ai-btn">‚ú® Generate Question with AI</button>
                    <div class="error" id="ai-error"></div>
                    
                    <div id="ai-result-container" class="hidden" style="margin-top: 25px; padding: 20px; background: white; border-radius: 12px; border: 1px solid #e0e0e0;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;">AI Generated Question</h4>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <span class="question-tag" id="ai-display-subject">Subject</span>
                            <span class="question-tag" id="ai-display-difficulty" style="background: #e3f2fd;">Difficulty</span>
                        </div>
                        <div id="ai-question-text" style="font-weight: 500; margin-bottom: 15px; font-size: 1.05rem;"></div>

                        <div style="margin-left: 25px; margin-bottom: 15px;">
                            <div>A) <span id="ai-option-a"></span></div>
                            <div>B) <span id="ai-option-b"></span></div>
                            <div>C) <span id="ai-option-c"></span></div>
                            <div>D) <span id="ai-option-d"></span></div>
                        </div>

                        <div style="background: #e8f5e9; padding: 12px; border-radius: 8px; margin: 15px 0;">
                            <strong>‚úì Correct Answer:</strong> <span id="ai-correct-answer"></span><br>
                            <strong>üí° Explanation:</strong> <span id="ai-explanation"></span>
                        </div>

                        <div style="display: flex; gap: 15px; margin-top: 20px;">
                            <button class="success-btn" style="flex: 1;" id="accept-ai-btn">‚úÖ Accept & Add to Bank</button>
                            <button class="admin-btn" style="flex: 1;" id="regenerate-ai-btn">üîÑ Generate New Question</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Candidate Login Screen -->
            <div id="candidate-login-screen" class="screen">
                <h2 style="text-align: center; margin-bottom: 25px; color: var(--primary);">Start Your Exam</h2>
                <div class="form-group">
                    <label for="exam-code-input">Exam Code</label>
                    <input type="text" id="exam-code-input" placeholder="Enter exam code (case sensitive)">
                </div>
                <div class="form-group">
                    <label for="candidate-name">Your Full Name</label>
                    <input type="text" id="candidate-name" placeholder="As per your application">
                </div>
                <div class="form-group">
                    <label for="candidate-mobile">Mobile Number *</label>
                    <input type="tel" id="candidate-mobile" placeholder="Enter your 10-digit mobile number" required>
                </div>
                <button id="start-exam-btn">Begin Exam</button>
                <p class="error" id="login-error"></p>
                <div style="text-align: center; margin-top: 25px;">
                    <button class="admin-btn" id="admin-login-btn">Admin Login ‚Üí</button>
                </div>
            </div>

            <!-- Exam Screen -->
            <div id="exam-screen" class="screen">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="timer" id="timer-display">‚è±Ô∏è Time Remaining: 10:00</div>
                    <button style="background: var(--danger); color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 0.85rem;" id="candidate-logout-btn">Logout</button>
                </div>

                <div class="question-container">
                    <div class="question-tag" id="question-subject-display">Reasoning</div>
                    <div class="question-number">Question <span id="current-q-num">1</span> of <span id="total-questions">5</span></div>
                    <div class="question-text" id="question-text-display">Loading question...</div>
                    
                    <div class="options">
                        <div class="option" data-index="0">
                            <span class="option-letter">A</span>
                            <span id="option-a-display">Loading...</span>
                        </div>
                        <div class="option" data-index="1">
                            <span class="option-letter">B</span>
                            <span id="option-b-display">Loading...</span>
                        </div>
                        <div class="option" data-index="2">
                            <span class="option-letter">C</span>
                            <span id="option-c-display">Loading...</span>
                        </div>
                        <div class="option" data-index="3">
                            <span class="option-letter">D</span>
                            <span id="option-d-display">Loading...</span>
                        </div>
                    </div>
                </div>
                
                <div class="progress">Question <span id="progress-num">1</span> of <span id="progress-total">5</span></div>
                
                <div class="navigation">
                    <button id="prev-btn" disabled>‚Üê Previous</button>
                    <button id="next-btn">Next ‚Üí</button>
                    <button id="submit-btn" class="success-btn" style="display: none;">Submit Exam</button>
                </div>
            </div>

            <!-- Result Screen -->
            <div id="result-screen" class="screen">
                <div class="result-container">
                    <h2>‚úÖ Exam Completed!</h2>
                    <p style="font-size: 1.2rem; margin: 15px 0; color: var(--dark);">Thank you for attempting Polite Coaching Centre test.</p>

                    <div class="score-display" id="final-score">0.00</div>
                    <p style="font-size: 1.1rem; color: var(--primary); margin-bottom: 25px;">Your Final Score</p>

                    <div style="background: #e8f4fc; padding: 20px; border-radius: 12px; margin: 25px 0;">
                        <p style="margin: 8px 0; font-size: 1.05rem;"><strong>Exam Code:</strong> <span id="result-exam-code">REASONING_01</span></p>
                        <p style="margin: 8px 0; font-size: 1.05rem;"><strong>Name:</strong> <span id="result-name">Candidate Name</span></p>
                        <p style="margin: 8px 0; font-size: 1.05rem;"><strong>Mobile:</strong> <span id="result-mobile">9876543210</span></p>
                    </div>

                    <p style="margin: 20px 0; font-weight: 500; line-height: 1.6;">
                        Your score has been recorded successfully.
                    </p>

                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button class="primary-btn" id="view-my-answers-btn">üìä View Detailed Results</button>
                        <button class="success-btn" id="restart-btn">Take Another Exam</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div class="notification-container" id="notification-container"></div>

    <script>
        // Global variables
        let isAdminLoggedIn = false;
        let currentExam = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let examTimer = null;
        let timeRemaining = 0;
        let startTime = null;
        let aiGeneratedQuestion = null;
        let extractedQuestions = [];
        let candidateDetailedAnswers = null; // Store candidate's detailed results for viewing

        // Sample data
        questions = [
            {
                ID: "Q1",
                Subject: "Math",
                Question: "What is 5 √ó 6?",
                'Option A': "25",
                'Option B': "30",
                'Option C': "35",
                'Option D': "40",
                Correct: "B"
            },
            {
                ID: "Q2",
                Subject: "Reasoning",
                Question: "2, 4, 8, 16, ?",
                'Option A': "20",
                'Option B': "24",
                'Option C': "32",
                'Option D': "64",
                Correct: "C"
            },
            {
                ID: "Q3",
                Subject: "GK",
                Question: "Who is the current Prime Minister of India?",
                'Option A': "Narendra Modi",
                'Option B': "Manmohan Singh",
                'Option C': "Rahul Gandhi",
                'Option D': "Amit Shah",
                Correct: "A"
            },
            {
                ID: "Q4",
                Subject: "Math",
                Question: "If a shirt costs ‚Çπ800 after a 20% discount, what was its original price?",
                'Option A': "‚Çπ900",
                'Option B': "‚Çπ960",
                'Option C': "‚Çπ1000",
                'Option D': "‚Çπ1200",
                Correct: "C"
            },
            {
                ID: "Q5",
                Subject: "Reasoning",
                Question: "If all Bloops are Razzies and all Razzies are Lazzies, then all Bloops are definitely Lazzies. Is this statement true?",
                'Option A': "True",
                'Option B': "False",
                'Option C': "Cannot be determined",
                'Option D': "Only sometimes",
                Correct: "A"
            }
        ];

        exams = [
            {
                'Exam Code': "SAMPLE01",
                'Title': "Sample Reasoning & Math Test",
                'Duration (mins)': "10",
                'Expiry (IST)': new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('.')[0] + 'Z',
                'Question IDs': "Q1,Q2,Q3,Q4,Q5"
            }
        ];

        // Session Management
        function saveSession(userType, userData) {
            localStorage.setItem('userType', userType);
            localStorage.setItem('userData', JSON.stringify(userData));
        }

        function getSession() {
            const userType = localStorage.getItem('userType');
            const userData = localStorage.getItem('userData');
            return userType && userData ? { userType, userData: JSON.parse(userData) } : null;
        }

        function clearSession() {
            localStorage.removeItem('userType');
            localStorage.removeItem('userData');
        }

        // Check if user is already logged in
        const session = getSession();
        if (session) {
            if (session.userType === 'candidate') {
                showCandidateDashboard(session.userData);
            } else if (session.userType === 'admin') {
                document.getElementById('hero-landing').classList.remove('active');
                document.getElementById('admin-panel').classList.add('active');
            }
        }

        // Navigation: Hero Landing <-> Signup
        document.getElementById('signup-btn').addEventListener('click', function() {
            document.getElementById('hero-landing').classList.remove('active');
            document.getElementById('candidate-signup-screen').classList.add('active');
        });

        document.getElementById('back-to-hero-from-signup').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('candidate-signup-screen').classList.remove('active');
            document.getElementById('hero-landing').classList.add('active');
        });

        // Navigation: Hero Landing <-> Signin
        document.getElementById('signin-btn').addEventListener('click', function() {
            document.getElementById('hero-landing').classList.remove('active');
            document.getElementById('candidate-signin-screen').classList.add('active');
        });

        document.getElementById('back-to-hero-from-signin').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('candidate-signin-screen').classList.remove('active');
            document.getElementById('hero-landing').classList.add('active');
        });

        // Navigation: Signup <-> Signin
        document.getElementById('goto-signin-link').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('candidate-signup-screen').classList.remove('active');
            document.getElementById('candidate-signin-screen').classList.add('active');
        });

        document.getElementById('goto-signup-link').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('candidate-signin-screen').classList.remove('active');
            document.getElementById('candidate-signup-screen').classList.add('active');
        });

        // Navigation: Signin <-> Forgot Password
        document.getElementById('forgot-password-link').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('candidate-signin-screen').classList.remove('active');
            document.getElementById('forgot-password-screen').classList.add('active');
            // Reset the form
            document.getElementById('forgot-email').value = '';
            document.getElementById('reset-result').style.display = 'none';
        });

        document.getElementById('back-to-signin-from-forgot').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('forgot-password-screen').classList.remove('active');
            document.getElementById('candidate-signin-screen').classList.add('active');
        });

        document.getElementById('goto-signin-after-reset').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('forgot-password-screen').classList.remove('active');
            document.getElementById('candidate-signin-screen').classList.add('active');
        });

        // Navigation: Hero Landing <-> Admin Login
        document.getElementById('admin-link').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('hero-landing').classList.remove('active');
            document.getElementById('admin-login-screen').classList.add('active');
        });

        document.getElementById('back-to-hero-from-admin').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('admin-login-screen').classList.remove('active');
            document.getElementById('hero-landing').classList.add('active');
        });

        // Candidate Signup
        document.getElementById('signup-submit-btn').addEventListener('click', async function() {
            const name = document.getElementById('signup-name').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            const mobile = document.getElementById('signup-mobile').value.trim();
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('signup-confirm-password').value;

            // Validation
            if (!name || !email || !mobile || !password || !confirmPassword) {
                window.PoliteCCAPI.showNotification('Please fill all fields', 'error');
                return;
            }

            if (mobile.length !== 10 || isNaN(mobile)) {
                window.PoliteCCAPI.showNotification('Please enter a valid 10-digit mobile number', 'error');
                return;
            }

            if (password !== confirmPassword) {
                window.PoliteCCAPI.showNotification('Passwords do not match', 'error');
                return;
            }

            if (password.length < 6) {
                window.PoliteCCAPI.showNotification('Password must be at least 6 characters', 'error');
                return;
            }

            // Call API to create account
            const result = await window.PoliteCCAPI.candidateSignup({ name, email, mobile, password });

            if (result) {
                // Clear form
                document.getElementById('signup-name').value = '';
                document.getElementById('signup-email').value = '';
                document.getElementById('signup-mobile').value = '';
                document.getElementById('signup-password').value = '';
                document.getElementById('signup-confirm-password').value = '';

                // Navigate to signin
                document.getElementById('candidate-signup-screen').classList.remove('active');
                document.getElementById('candidate-signin-screen').classList.add('active');
            }
        });

        // Candidate Login
        document.getElementById('signin-submit-btn').addEventListener('click', async function() {
            const email = document.getElementById('signin-email').value.trim();
            const password = document.getElementById('signin-password').value;

            if (!email || !password) {
                window.PoliteCCAPI.showNotification('Please fill all fields', 'error');
                return;
            }

            const result = await window.PoliteCCAPI.candidateLogin(email, password);

            if (result) {
                // Save session
                saveSession('candidate', result);

                // Clear form
                document.getElementById('signin-email').value = '';
                document.getElementById('signin-password').value = '';

                // Show dashboard
                showCandidateDashboard(result);
            }
        });

        // Password Reset
        document.getElementById('reset-password-btn').addEventListener('click', async function() {
            const email = document.getElementById('forgot-email').value.trim();

            if (!email) {
                window.PoliteCCAPI.showNotification('Please enter your email address', 'error');
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                window.PoliteCCAPI.showNotification('Please enter a valid email address', 'error');
                return;
            }

            // Disable button while processing
            const btn = document.getElementById('reset-password-btn');
            btn.disabled = true;
            btn.textContent = 'Resetting...';

            const result = await window.PoliteCCAPI.resetPassword(email);

            // Re-enable button
            btn.disabled = false;
            btn.textContent = 'Reset Password';

            if (result) {
                // Show the temporary password
                document.getElementById('new-temp-password').textContent = result.tempPassword;
                document.getElementById('reset-result').style.display = 'block';

                // Hide the form elements
                document.getElementById('forgot-email').style.display = 'none';
                btn.style.display = 'none';

                window.PoliteCCAPI.showNotification('‚úÖ Password reset successful!', 'success');
            }
        });

        // Show Candidate Dashboard
        async function showCandidateDashboard(userData) {
            document.getElementById('candidate-signin-screen').classList.remove('active');
            document.getElementById('hero-landing').classList.remove('active');
            document.getElementById('candidate-dashboard').classList.add('active');

            // Populate dashboard
            document.getElementById('dashboard-name').textContent = userData.name;
            document.getElementById('dashboard-email').textContent = userData.email;
            document.getElementById('dashboard-mobile').textContent = userData.mobile;

            // Load exam history
            const examHistory = await window.PoliteCCAPI.getCandidateExamHistory(userData.email);

            if (examHistory && examHistory.examsGiven > 0) {
                document.getElementById('total-exams-given').textContent = examHistory.examsGiven;

                // Calculate average score
                const avgScore = examHistory.examHistory.reduce((sum, exam) => sum + (exam.score || 0), 0) / examHistory.examsGiven;
                document.getElementById('average-score').textContent = avgScore.toFixed(1);

                // Display exam history
                const container = document.getElementById('exam-history-container');
                let historyHTML = '';

                examHistory.examHistory.forEach(exam => {
                    const date = new Date(exam.date).toLocaleDateString('en-IN');
                    historyHTML += `
                        <div class="exam-history-card">
                            <div class="exam-card-title">Exam: ${exam.examCode}</div>
                            <div class="exam-card-details">
                                <div class="exam-card-score">Score: ${exam.score}</div>
                                <div class="exam-card-date">${date}</div>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = historyHTML;
            } else {
                document.getElementById('total-exams-given').textContent = '0';
                document.getElementById('average-score').textContent = '0';
            }
        }

        // Candidate Dashboard - Take Exam
        document.getElementById('take-exam-dashboard-btn').addEventListener('click', function() {
            const session = getSession();
            if (session && session.userType === 'candidate') {
                // Pre-fill candidate info
                document.getElementById('candidate-name').value = session.userData.name;
                document.getElementById('candidate-mobile').value = session.userData.mobile;
            }
            document.getElementById('candidate-dashboard').classList.remove('active');
            document.getElementById('candidate-login-screen').classList.add('active');
        });

        // Hero - Start Exam (for non-logged-in users)
        document.getElementById('start-exam-hero-btn').addEventListener('click', function() {
            document.getElementById('hero-landing').classList.remove('active');
            document.getElementById('candidate-signin-screen').classList.add('active');
        });

        // Candidate Logout
        document.getElementById('candidate-logout-link').addEventListener('click', function(e) {
            e.preventDefault();
            if (confirm('Are you sure you want to logout?')) {
                clearSession();
                document.getElementById('candidate-dashboard').classList.remove('active');
                document.getElementById('hero-landing').classList.add('active');
                window.PoliteCCAPI.showNotification('Logged out successfully', 'success');
            }
        });

        // Admin Login
        document.getElementById('admin-login-btn').addEventListener('click', async function() {
            const username = document.getElementById('admin-username').value.trim();
            const password = document.getElementById('admin-password').value;
            const errorElement = document.getElementById('admin-login-error');

            if (!username || !password) {
                errorElement.textContent = 'Please fill all fields';
                return;
            }

            const result = await window.PoliteCCAPI.adminLogin(username, password);

            if (result) {
                saveSession('admin', result);

                document.getElementById('admin-login-screen').classList.remove('active');
                document.getElementById('admin-panel').classList.add('active');
                document.getElementById('question-bank-section').classList.remove('hidden');

                // Check system status when admin logs in
                if (window.PoliteCCAPI && window.PoliteCCAPI.checkSystemStatus) {
                    await window.PoliteCCAPI.checkSystemStatus();
                }

                // Clear form
                document.getElementById('admin-username').value = '';
                document.getElementById('admin-password').value = '';
                errorElement.textContent = '';
            } else {
                errorElement.textContent = '‚ùå Invalid credentials';
            }
        });

        // Admin logout function
        document.getElementById('logout-btn').addEventListener('click', function() {
            clearSession();
            document.getElementById('admin-panel').classList.remove('active');
            document.getElementById('hero-landing').classList.add('active');
            window.PoliteCCAPI.showNotification('Logged out successfully', 'success');
        });

        // Exam screen logout function (for candidates taking exams)
        const candidateLogoutBtn = document.getElementById('candidate-logout-btn');
        if (candidateLogoutBtn) {
            candidateLogoutBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to logout? Your current progress will be lost.')) {
                    // Stop timer
                    if (typeof timerInterval !== 'undefined' && timerInterval) {
                        clearInterval(timerInterval);
                    }
                    // Reset to dashboard or landing
                    const session = getSession();
                    document.getElementById('exam-screen').classList.remove('active');
                    if (session && session.userType === 'candidate') {
                        showCandidateDashboard(session.userData);
                    } else {
                        document.getElementById('hero-landing').classList.add('active');
                    }
                    // Clear form fields
                    document.getElementById('exam-code-input').value = '';
                    document.getElementById('candidate-name').value = '';
                    document.getElementById('candidate-mobile').value = '';
                }
            });
        }

        // Show question bank
        document.getElementById('question-bank-btn').addEventListener('click', async function() {
            document.getElementById('question-bank-section').classList.remove('hidden');
            document.getElementById('create-exam-section').classList.add('hidden');
            document.getElementById('view-results-section').classList.add('hidden');
            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('ai-generator-section').classList.add('hidden');
            
            // Load questions from database
            const questionsList = document.getElementById('questions-list');
            questionsList.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Loading questions from database...</p>';
            
            // Load questions via API if available
            if (window.PoliteCCAPI && window.PoliteCCAPI.loadQuestions) {
                questions = await window.PoliteCCAPI.loadQuestions() || questions;
            }
            
            // Remove duplicates and generate unique simple IDs
            const seenIds = new Set();
            const uniqueQuestions = [];

            // Find the highest existing question number
            let maxNum = 0;
            questions.forEach(q => {
                if (q.ID) {
                    // Support both old format (q1, q2) and new format (Q0001, Q0002)
                    const match = q.ID.match(/^[qQ](\d+)$/);
                    if (match) {
                        const num = parseInt(match[1]);
                        if (!isNaN(num) && num > maxNum) {
                            maxNum = num;
                        }
                    }
                }
            });
            let idCounter = maxNum + 1;

            questions.forEach(q => {
                // Generate unique ID if needed (Q0001, Q0002, etc.)
                if (!q.ID || seenIds.has(q.ID)) {
                    q.ID = 'Q' + String(idCounter).padStart(4, '0');
                    idCounter++;
                }

                // Check if this question content is duplicate
                const isDuplicate = uniqueQuestions.some(uq =>
                    uq.Question === q.Question &&
                    uq['Option A'] === q['Option A'] &&
                    uq['Option B'] === q['Option B']
                );

                if (!isDuplicate) {
                    seenIds.add(q.ID);
                    uniqueQuestions.push(q);
                }
            });

            // Update questions array and sort (newest first - descending by ID number)
            questions = uniqueQuestions;
            questions.sort((a, b) => {
                const matchA = a.ID.match(/^[qQ](\d+)$/);
                const matchB = b.ID.match(/^[qQ](\d+)$/);
                const numA = matchA ? parseInt(matchA[1]) : 0;
                const numB = matchB ? parseInt(matchB[1]) : 0;
                return numB - numA; // Descending order (newest first)
            });
            
            // Render questions with Delete buttons
            let html = '';
            
            if (questions.length === 0) {
                html = '<p style="text-align: center; color: #7f8c8d;">No questions found. Click "Add New Question" button above to add your first question!</p>';
            } else {
                questions.forEach((q, index) => {
                    html += `
                    <div class="question-item" data-question-id="${q.id || ''}" data-index="${index}" style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 12px; border-left: 3px solid var(--secondary); position: relative; padding-right: 60px; padding-left: 50px;">
                        <!-- Checkbox for selection -->
                        <div style="position: absolute; top: 15px; left: 15px;">
                            <input type="checkbox" class="question-select-checkbox" data-index="${index}" style="width: 20px; height: 20px; cursor: pointer;" checked>
                        </div>

                        <!-- Action buttons in top right -->
                        <div style="position: absolute; top: 10px; right: 10px; display: flex; flex-direction: column; gap: 5px;">
                            <button class="delete-question-btn" data-question-id="${q.id || ''}" data-index="${index}" title="Delete Question" style="background: var(--danger); color: white; border: none; width: 35px; height: 35px; border-radius: 6px; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                üóëÔ∏è
                            </button>
                            <button class="edit-question-btn" data-question-id="${q.id || ''}" data-index="${index}" title="Edit Question" style="background: var(--primary); color: white; border: none; width: 35px; height: 35px; border-radius: 6px; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                ‚úèÔ∏è
                            </button>
                        </div>

                        <div style="margin-bottom: 8px;">
                            <strong style="font-size: 1.1rem;">${q.ID}</strong>
                            <span class="question-tag" style="margin-left: 10px; background: var(--secondary); color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.85rem;">${q.Subject}</span>
                        </div>
                        <p style="margin-bottom: 10px; font-weight: 500; font-size: 1.1rem;">${q.Question}</p>
                        <div style="margin-left: 25px; margin-bottom: 8px;">
                            <div style="margin: 5px 0;">A) ${q['Option A']}</div>
                            <div style="margin: 5px 0;">B) ${q['Option B']}</div>
                            <div style="margin: 5px 0;">C) ${q['Option C']}</div>
                            <div style="margin: 5px 0;">D) ${q['Option D']}</div>
                        </div>
                        <div style="color: var(--success); font-weight: 600; background: #e8f5e9; padding: 8px; border-radius: 6px; display: inline-block;">
                            ‚úÖ Correct Answer: ${q.Correct}
                        </div>
                    </div>
                    `;
                });
            }
            
            questionsList.innerHTML = html;
            
            // Add delete button event listeners
            document.querySelectorAll('.delete-question-btn').forEach(btn => {
                btn.addEventListener('click', async function(e) {
                    e.stopPropagation();
                    const questionId = this.getAttribute('data-question-id');
                    const index = parseInt(this.getAttribute('data-index'));

                    if (confirm('Are you sure you want to delete this question?')) {
                        // Delete from database if ID exists
                        if (questionId && window.PoliteCCAPI && window.PoliteCCAPI.deleteQuestionFromDatabase) {
                            const success = await window.PoliteCCAPI.deleteQuestionFromDatabase(questionId);
                            if (success) {
                                // Remove from local array
                                questions.splice(index, 1);
                                // Refresh display
                                document.getElementById('question-bank-btn').click();
                            }
                        } else {
                            // Remove from local array only
                            questions.splice(index, 1);
                            // Refresh display
                            document.getElementById('question-bank-btn').click();
                        }
                    }
                });
            });

            // Add edit button event listeners
            document.querySelectorAll('.edit-question-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const index = parseInt(this.getAttribute('data-index'));
                    const question = questions[index];

                    // Show the add question form
                    document.getElementById('add-question-form').classList.remove('hidden');

                    // Populate form with existing question data
                    document.getElementById('question-subject').value = question.Subject;
                    document.getElementById('question-text').value = question.Question;
                    document.getElementById('option-a').value = question['Option A'];
                    document.getElementById('option-b').value = question['Option B'];
                    document.getElementById('option-c').value = question['Option C'];
                    document.getElementById('option-d').value = question['Option D'];

                    // Set correct answer
                    const correctIndex = question.Correct.charCodeAt(0) - 65; // A=0, B=1, C=2, D=3
                    document.getElementById('correct-answer').value = correctIndex;

                    // Change button text to "Update Question"
                    const addBtn = document.getElementById('add-question-btn');
                    addBtn.textContent = 'Update Question';
                    addBtn.setAttribute('data-edit-index', index);
                    addBtn.setAttribute('data-edit-id', question.id || '');
                    addBtn.setAttribute('data-edit-mode', 'true');

                    // Scroll to form
                    document.getElementById('add-question-form').scrollIntoView({ behavior: 'smooth' });
                });
            });
        });

        // Select All questions
        document.getElementById('select-all-questions-btn').addEventListener('click', function() {
            document.querySelectorAll('.question-select-checkbox').forEach(cb => {
                cb.checked = true;
            });
            window.PoliteCCAPI.showNotification('‚úÖ All questions selected', 'success');
        });

        // Deselect All questions
        document.getElementById('deselect-all-questions-btn').addEventListener('click', function() {
            document.querySelectorAll('.question-select-checkbox').forEach(cb => {
                cb.checked = false;
            });
            window.PoliteCCAPI.showNotification('‚úÖ All questions deselected', 'info');
        });

        // Export questions to CSV
        document.getElementById('export-questions-btn').addEventListener('click', function() {
            exportQuestionsToCSV();
        });

        // Function to export questions to CSV (only selected ones)
        function exportQuestionsToCSV() {
            if (!questions || questions.length === 0) {
                window.PoliteCCAPI.showNotification('No questions to export', 'error');
                return;
            }

            // Get selected question indices
            const selectedIndices = [];
            document.querySelectorAll('.question-select-checkbox').forEach(cb => {
                if (cb.checked) {
                    selectedIndices.push(parseInt(cb.getAttribute('data-index')));
                }
            });

            if (selectedIndices.length === 0) {
                window.PoliteCCAPI.showNotification('‚ö†Ô∏è Please select at least one question to export', 'error');
                return;
            }

            // Filter questions to only selected ones
            const selectedQuestions = questions.filter((q, index) => selectedIndices.includes(index));

            // Prepare CSV content with all question details
            const headers = ['ID', 'Subject', 'Question', 'Option A', 'Option B', 'Option C', 'Option D', 'Correct Answer'];
            const rows = selectedQuestions.map(q => {
                return [
                    q.ID || '',
                    q.Subject || '',
                    q.Question || '',
                    q['Option A'] || '',
                    q['Option B'] || '',
                    q['Option C'] || '',
                    q['Option D'] || '',
                    q.Correct || ''
                ];
            });

            // Build CSV string
            let csvContent = headers.join(',') + '\n';
            rows.forEach(row => {
                // Escape commas, quotes, and newlines in data
                const escapedRow = row.map(cell => {
                    const cellStr = String(cell);
                    if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                        return '"' + cellStr.replace(/"/g, '""') + '"';
                    }
                    return cellStr;
                });
                csvContent += escapedRow.join(',') + '\n';
            });

            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Question_Bank_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            window.PoliteCCAPI.showNotification(`‚úÖ Exported ${selectedQuestions.length} questions successfully!`, 'success');
        }

        // Toggle Add Question Form
        document.getElementById('toggle-add-question-btn').addEventListener('click', function() {
            const form = document.getElementById('add-question-form');
            form.classList.toggle('hidden');
        });

        // Close Add Question Form
        document.getElementById('close-add-question-btn').addEventListener('click', function() {
            document.getElementById('add-question-form').classList.add('hidden');
        });

        // Add/Update question to bank
        document.getElementById('add-question-btn').addEventListener('click', async function() {
            const subject = document.getElementById('question-subject').value;
            const question = document.getElementById('question-text').value.trim();
            const optionA = document.getElementById('option-a').value.trim();
            const optionB = document.getElementById('option-b').value.trim();
            const optionC = document.getElementById('option-c').value.trim();
            const optionD = document.getElementById('option-d').value.trim();
            const correct = document.getElementById('correct-answer').value;

            const questionError = document.getElementById('question-error');
            const questionSuccess = document.getElementById('question-success');

            // Clear previous messages
            if (questionError) questionError.textContent = '';
            if (questionSuccess) questionSuccess.textContent = '';

            // Validate inputs
            if (!question || !optionA || !optionB || !optionC || !optionD) {
                if (questionError) {
                    questionError.textContent = '‚ùå Please fill in all fields!';
                    setTimeout(() => {
                        questionError.textContent = '';
                    }, 3000);
                }
                return;
            }

            const correctAnswer = ['A', 'B', 'C', 'D'][parseInt(correct)];
            const isEditMode = this.getAttribute('data-edit-mode') === 'true';
            const editIndex = parseInt(this.getAttribute('data-edit-index'));
            const editId = this.getAttribute('data-edit-id');

            if (isEditMode) {
                // Update existing question
                if (window.PoliteCCAPI && window.PoliteCCAPI.updateQuestionInDatabase && editId) {
                    const success = await window.PoliteCCAPI.updateQuestionInDatabase(editId, {
                        subject: subject,
                        question: question,
                        optionA: optionA,
                        optionB: optionB,
                        optionC: optionC,
                        optionD: optionD,
                        correct: correctAnswer
                    });

                    if (success) {
                        if (questionSuccess) {
                            questionSuccess.textContent = '‚úÖ Question updated successfully!';
                            setTimeout(() => {
                                questionSuccess.textContent = '';
                            }, 3000);
                        }
                    }
                } else {
                    // Update in local array
                    questions[editIndex].Subject = subject;
                    questions[editIndex].Question = question;
                    questions[editIndex]['Option A'] = optionA;
                    questions[editIndex]['Option B'] = optionB;
                    questions[editIndex]['Option C'] = optionC;
                    questions[editIndex]['Option D'] = optionD;
                    questions[editIndex].Correct = correctAnswer;

                    if (questionSuccess) {
                        questionSuccess.textContent = '‚úÖ Question updated successfully!';
                        setTimeout(() => {
                            questionSuccess.textContent = '';
                        }, 3000);
                    }
                }

                // Reset edit mode
                this.textContent = 'Add Question to Bank';
                this.removeAttribute('data-edit-mode');
                this.removeAttribute('data-edit-index');
                this.removeAttribute('data-edit-id');
            } else {
                // Add new question to database if API is available
                if (window.PoliteCCAPI && window.PoliteCCAPI.addQuestionToDatabase) {
                    const success = await window.PoliteCCAPI.addQuestionToDatabase({
                        subject: subject,
                        question: question,
                        optionA: optionA,
                        optionB: optionB,
                        optionC: optionC,
                        optionD: optionD,
                        correct: correctAnswer
                    });

                    if (success && questionSuccess) {
                        questionSuccess.textContent = '‚úÖ Question added successfully!';
                        setTimeout(() => {
                            questionSuccess.textContent = '';
                        }, 3000);
                    }
                } else {
                    // Add to local array if no API
                    const questionId = `q${questionCounter++}`;

                    questions.push({
                        ID: questionId,
                        Subject: subject,
                        Question: question,
                        'Option A': optionA,
                        'Option B': optionB,
                        'Option C': optionC,
                        'Option D': optionD,
                        Correct: correctAnswer
                    });

                    if (questionSuccess) {
                        questionSuccess.textContent = '‚úÖ Question added successfully!';
                        setTimeout(() => {
                            questionSuccess.textContent = '';
                        }, 3000);
                    }
                }
            }

            // Clear form
            document.getElementById('question-text').value = '';
            document.getElementById('option-a').value = '';
            document.getElementById('option-b').value = '';
            document.getElementById('option-c').value = '';
            document.getElementById('option-d').value = '';
            document.getElementById('correct-answer').value = '0';

            // Refresh question list and hide form
            document.getElementById('add-question-form').classList.add('hidden');
            document.getElementById('question-bank-btn').click();
        });

        // Show create exam
        document.getElementById('create-exam-btn').addEventListener('click', function() {
            document.getElementById('question-bank-section').classList.add('hidden');
            document.getElementById('create-exam-section').classList.remove('hidden');
            document.getElementById('view-results-section').classList.add('hidden');
            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('ai-generator-section').classList.add('hidden');
            
            // Render exam questions list
            const examQuestionsList = document.getElementById('exam-questions-list');

            if (questions.length === 0) {
                examQuestionsList.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No questions available. Please add questions first!</p>';
            } else {
                let html = '<div style="max-height: 450px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px;">';

                questions.forEach(q => {
                    const subjectColors = {
                        'Math': '#3498db',
                        'Reasoning': '#9b59b6',
                        'GK': '#e67e22',
                        'Others': '#95a5a6'
                    };
                    const color = subjectColors[q.Subject] || '#95a5a6';

                    html += `
                    <label class="exam-question-item" style="display: flex; align-items: flex-start; background: #f8f9fa; border-radius: 8px; padding: 12px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent;">
                        <input type="checkbox" class="question-checkbox" value="${q.id}" data-question-id="${q.ID}" style="margin-right: 12px; margin-top: 4px; width: 18px; height: 18px; cursor: pointer; flex-shrink: 0;">
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                                <strong style="font-size: 1rem; color: var(--secondary);">${q.ID}</strong>
                                <span style="background: ${color}; color: white; padding: 2px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">${q.Subject}</span>
                            </div>
                            <div style="color: #2c3e50; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; font-size: 0.95rem; margin-bottom: 8px;"><strong>Q:</strong> ${q.Question}</div>
                            <details style="margin-top: 8px; cursor: pointer;">
                                <summary style="color: #3498db; font-weight: 600; font-size: 0.85rem; user-select: none; padding: 4px 0;">Show Options</summary>
                                <div style="margin-top: 8px; padding: 8px; background: white; border-radius: 6px; border: 1px solid #e0e0e0;">
                                    <div style="margin: 4px 0; color: #555;"><strong>A)</strong> ${q['Option A']}</div>
                                    <div style="margin: 4px 0; color: #555;"><strong>B)</strong> ${q['Option B']}</div>
                                    <div style="margin: 4px 0; color: #555;"><strong>C)</strong> ${q['Option C']}</div>
                                    <div style="margin: 4px 0; color: #555;"><strong>D)</strong> ${q['Option D']}</div>
                                    <div style="margin-top: 8px; padding: 6px; background: #d4edda; border-radius: 4px; color: #155724; font-weight: 600;"><strong>‚úì Correct:</strong> ${q.Correct}</div>
                                </div>
                            </details>
                        </div>
                    </label>
                    `;
                });

                html += '</div>';
                examQuestionsList.innerHTML = html;

                // Update counter when checkboxes change
                function updateSelectedCount() {
                    const checkedCount = document.querySelectorAll('.question-checkbox:checked').length;
                    document.getElementById('selected-count').textContent = checkedCount + ' Selected';
                }

                // Add event listeners to checkboxes
                document.querySelectorAll('.question-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', updateSelectedCount);
                });

                // Add hover effect to question items
                document.querySelectorAll('.exam-question-item').forEach(item => {
                    item.addEventListener('mouseenter', function() {
                        this.style.borderColor = 'var(--primary)';
                        this.style.background = '#e8f4fd';
                    });
                    item.addEventListener('mouseleave', function() {
                        const checkbox = this.querySelector('.question-checkbox');
                        if (!checkbox.checked) {
                            this.style.borderColor = 'transparent';
                            this.style.background = '#f8f9fa';
                        }
                    });
                });

                // Reset counter
                updateSelectedCount();

                // Random selection button
                document.getElementById('random-select-btn').addEventListener('click', function() {
                    const randomCount = parseInt(document.getElementById('random-count').value);

                    if (!randomCount || randomCount < 1) {
                        alert('Please enter a valid number of questions to select.');
                        return;
                    }

                    if (randomCount > questions.length) {
                        alert(`You can only select up to ${questions.length} questions from the bank.`);
                        return;
                    }

                    // Uncheck all first
                    document.querySelectorAll('.question-checkbox').forEach(cb => {
                        cb.checked = false;
                    });

                    // Get all checkboxes
                    const allCheckboxes = Array.from(document.querySelectorAll('.question-checkbox'));

                    // Shuffle and select random questions
                    const shuffled = allCheckboxes.sort(() => Math.random() - 0.5);
                    const selectedCheckboxes = shuffled.slice(0, randomCount);

                    // Check the randomly selected checkboxes
                    selectedCheckboxes.forEach(cb => {
                        cb.checked = true;
                    });

                    // Update counter
                    updateSelectedCount();

                    // Show notification
                    if (window.PoliteCCAPI && window.PoliteCCAPI.showNotification) {
                        window.PoliteCCAPI.showNotification(`üé≤ Randomly selected ${randomCount} questions!`, 'success');
                    }
                });
            }
        });

        // Create exam
        document.getElementById('create-exam-submit-btn').addEventListener('click', async function() {
            const examCode = document.getElementById('exam-code').value.trim().toUpperCase();
            const examTitle = document.getElementById('exam-title').value.trim();
            const duration = parseInt(document.getElementById('exam-duration').value);
            const expiryInput = document.getElementById('exam-expiry').value;

            if (!examCode || !examTitle || isNaN(duration) || duration < 5) {
                const examError = document.getElementById('exam-error');
                if (examError) {
                    examError.textContent = '‚ùå Please fill all fields correctly!';
                    setTimeout(() => {
                        examError.textContent = '';
                    }, 3000);
                }
                return;
            }

            // Validate expiry date
            if (!expiryInput) {
                const examError = document.getElementById('exam-error');
                if (examError) {
                    examError.textContent = '‚ùå Please select an expiry date!';
                    setTimeout(() => {
                        examError.textContent = '';
                    }, 3000);
                }
                return;
            }

            // Convert date value to Date object (set to end of day for comparison)
            // date input gives us "YYYY-MM-DD"
            const expiryDate = new Date(expiryInput + 'T23:59:59');

            // Check if the expiry date is valid
            if (isNaN(expiryDate.getTime())) {
                const examError = document.getElementById('exam-error');
                if (examError) {
                    examError.textContent = '‚ùå Invalid expiry date!';
                    setTimeout(() => {
                        examError.textContent = '';
                    }, 3000);
                }
                return;
            }

            // Check if expiry date is today or in the future (we don't need to check if it's in the past)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const expiryDateOnly = new Date(expiryInput);
            if (expiryDateOnly.getTime() < today.getTime()) {
                const examError = document.getElementById('exam-error');
                if (examError) {
                    examError.textContent = '‚ùå Expiry date must be today or in the future!';
                    setTimeout(() => {
                        examError.textContent = '';
                    }, 3000);
                }
                return;
            }

            // Get selected questions
            const checkboxes = document.querySelectorAll('.question-checkbox:checked');
            const selectedQuestions = Array.from(checkboxes).map(cb => cb.value);

            if (selectedQuestions.length < 5) {
                const examError = document.getElementById('exam-error');
                if (examError) {
                    examError.textContent = '‚ùå Please select at least 5 questions!';
                    setTimeout(() => {
                        examError.textContent = '';
                    }, 3000);
                }
                return;
            }

            // Format expiry date for Airtable (store date only in YYYY-MM-DD format)
            const formattedExpiry = expiryInput;

            console.log('üìÖ Debug - Expiry Input:', expiryInput);
            console.log('üìÖ Debug - Expiry Date:', expiryDate);
            console.log('üìÖ Debug - Formatted Expiry:', formattedExpiry);
            console.log('üìã Debug - Selected Questions (Record IDs):', selectedQuestions);

            // Create exam object
            const newExam = {
                'Exam Code': examCode,
                'Title': examTitle,
                'Duration (mins)': duration,
                'Expiry (IST)': formattedExpiry,
                'Question IDs': selectedQuestions
            };

            console.log('üì§ Debug - Exam Data Being Sent:', JSON.stringify(newExam, null, 2));

            // Save to database if API is available
            if (window.PoliteCCAPI && window.PoliteCCAPI.createExamInDatabase) {
                const success = await window.PoliteCCAPI.createExamInDatabase(newExam);

                if (success) {
                    // Show success
                    const examSuccess = document.getElementById('exam-success');
                    if (examSuccess) {
                        examSuccess.textContent = `‚úÖ Exam "${examCode}" created and saved successfully!`;
                        setTimeout(() => {
                            examSuccess.textContent = '';
                        }, 5000);
                    }

                    // Clear form
                    document.getElementById('exam-code').value = '';
                    document.getElementById('exam-title').value = '';
                    document.getElementById('exam-duration').value = '';
                    document.getElementById('exam-expiry').value = '';

                    // Uncheck all checkboxes
                    document.querySelectorAll('.question-checkbox').forEach(cb => cb.checked = false);
                    document.getElementById('selected-count').textContent = '0 Selected';
                }
            } else {
                // Fallback: Add to local array if API not available
                exams.push(newExam);

                // Show success
                const examSuccess = document.getElementById('exam-success');
                if (examSuccess) {
                    examSuccess.textContent = `‚úÖ Exam "${examCode}" created successfully!`;
                    setTimeout(() => {
                        examSuccess.textContent = '';
                    }, 5000);
                }

                // Show notification
                const notification = document.createElement('div');
                notification.className = 'notification success';
                notification.innerHTML = `‚úÖ Exam "${examCode}" created successfully!`;
                document.getElementById('notification-container').appendChild(notification);

                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
            }
        });

        // Show view results
        document.getElementById('view-results-btn').addEventListener('click', async function() {
            document.getElementById('question-bank-section').classList.add('hidden');
            document.getElementById('create-exam-section').classList.add('hidden');
            document.getElementById('view-results-section').classList.remove('hidden');
            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('ai-generator-section').classList.add('hidden');

            // Load exams into dropdown
            if (window.PoliteCCAPI && window.PoliteCCAPI.loadExams) {
                exams = await window.PoliteCCAPI.loadExams() || exams;
            }

            const examSelect = document.getElementById('results-exam-select');
            examSelect.innerHTML = '<option value="">-- Select Exam --</option>';

            exams.forEach(exam => {
                const option = document.createElement('option');
                option.value = exam['Exam Code'] || exam.examCode;
                option.textContent = `${exam['Exam Code'] || exam.examCode} - ${exam['Title'] || exam.title}`;
                examSelect.appendChild(option);
            });
        });

        // Handle exam selection for viewing results
        document.getElementById('results-exam-select').addEventListener('change', async function() {
            const examCode = this.value;
            const resultsContainer = document.getElementById('results-container');

            if (!examCode) {
                resultsContainer.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">Select an exam to view results.</p>';
                return;
            }

            resultsContainer.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">Loading results...</p>';

            // Get results from API
            let results = [];
            if (window.PoliteCCAPI && window.PoliteCCAPI.getExamResults) {
                results = await window.PoliteCCAPI.getExamResults(examCode) || [];
            }

            if (results.length === 0) {
                resultsContainer.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No results found for this exam.</p>';
                return;
            }

            // Display results in a table
            let html = `
                <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0; color: var(--secondary);">Results for: ${examCode}</h4>
                        <button id="export-results-btn" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: 600;">
                            üì• Export to CSV
                        </button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: var(--secondary); color: white;">
                                    <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">#</th>
                                    <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Name</th>
                                    <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Mobile</th>
                                    <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Score</th>
                                    <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            results.forEach((result, index) => {
                const score = result.Score || result.score || 0;
                const scoreColor = score >= 0 ? '#27ae60' : '#e74c3c';

                html += `
                    <tr class="result-row" data-result-index="${index}" style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'}; cursor: pointer; transition: background 0.2s;" onmouseenter="this.style.background='#e3f2fd'" onmouseleave="this.style.background='${index % 2 === 0 ? '#f8f9fa' : 'white'}'">
                        <td style="padding: 12px; border: 1px solid #ddd;">${index + 1}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; font-weight: 600;">${result.Name || result.name}</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">${result.Mobile || result.mobile}</td>
                        <td style="padding: 12px; border: 1px solid #ddd;"><span style="color: ${scoreColor}; font-weight: 700; font-size: 1.1rem;">${parseFloat(score).toFixed(2)}</span></td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                            <button class="view-detailed-btn" data-result-index="${index}" style="background: var(--primary); color: white; border: none; padding: 6px 15px; border-radius: 5px; cursor: pointer; font-weight: 600;" onclick="event.stopPropagation();">View Details</button>
                        </td>
                    </tr>
                `;
            });

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="detailed-result-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto;">
                    <div style="background: white; margin: 50px auto; max-width: 900px; border-radius: 10px; padding: 30px; position: relative;">
                        <button id="close-detailed-modal" style="position: absolute; top: 15px; right: 15px; background: var(--danger); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: 600;">‚úñ Close</button>
                        <div id="detailed-result-content"></div>
                    </div>
                </div>
            `;

            resultsContainer.innerHTML = html;

            // Add event listeners for detailed view buttons
            document.querySelectorAll('.view-detailed-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const resultIndex = parseInt(this.getAttribute('data-result-index'));
                    showDetailedResult(results[resultIndex], examCode);
                });
            });

            // Add event listeners for clickable rows
            document.querySelectorAll('.result-row').forEach(row => {
                row.addEventListener('click', function() {
                    const resultIndex = parseInt(this.getAttribute('data-result-index'));
                    showDetailedResult(results[resultIndex], examCode);
                });
            });

            // Add event listener for export button
            const exportBtn = document.getElementById('export-results-btn');
            if (exportBtn) {
                exportBtn.addEventListener('click', function() {
                    exportResultsToCSV(results, examCode);
                });
            }
        });

        // Function to export results to CSV
        function exportResultsToCSV(results, examCode) {
            if (!results || results.length === 0) {
                window.PoliteCCAPI.showNotification('No results to export', 'error');
                return;
            }

            // Prepare CSV content
            const headers = ['#', 'Name', 'Mobile', 'Score', 'Submitted At'];
            const rows = results.map((result, index) => {
                return [
                    index + 1,
                    result.Name || result.name || '',
                    result.Mobile || result.mobile || '',
                    parseFloat(result.Score || result.score || 0).toFixed(2),
                    result['Submitted At'] || result.submittedAt || ''
                ];
            });

            // Build CSV string
            let csvContent = headers.join(',') + '\n';
            rows.forEach(row => {
                // Escape commas and quotes in data
                const escapedRow = row.map(cell => {
                    const cellStr = String(cell);
                    if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                        return '"' + cellStr.replace(/"/g, '""') + '"';
                    }
                    return cellStr;
                });
                csvContent += escapedRow.join(',') + '\n';
            });

            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Results_${examCode}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            window.PoliteCCAPI.showNotification('‚úÖ Results exported successfully!', 'success');
        }

        // Function to show detailed result
        async function showDetailedResult(result, examCode) {
            const modal = document.getElementById('detailed-result-modal');
            const content = document.getElementById('detailed-result-content');

            // Get exam questions
            const exam = exams.find(e => (e['Exam Code'] || e.examCode) === examCode);
            if (!exam) {
                content.innerHTML = '<p>Error: Exam not found</p>';
                modal.style.display = 'block';
                return;
            }

            // Handle Question IDs - can be an array of record IDs or comma-separated string of question IDs (for backward compatibility)
            let questionIds = exam['Question IDs'] || exam['Questions'] || exam.questionIds || exam.QuestionIDs || exam.question_ids || '';
            if (typeof questionIds === 'string') {
                questionIds = questionIds.split(',').map(id => id.trim());
            }
            // Find questions by Airtable record ID (new format) or by Question ID field (old format)
            const examQuestions = questionIds.map(id =>
                questions.find(q => q.id === id || q.ID === id)
            ).filter(q => q);

            // Parse user answers
            let userAnswers = [];
            try {
                userAnswers = typeof result.Answers === 'string' ? JSON.parse(result.Answers) : result.Answers || [];
            } catch (e) {
                userAnswers = result.answers || [];
            }

            // Build detailed view
            let html = `
                <h3 style="color: var(--secondary); margin-bottom: 20px;">Detailed Result: ${result.Name || result.name}</h3>
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div><strong>Exam:</strong> ${examCode}</div>
                    <div><strong>Mobile:</strong> ${result.Mobile || result.mobile}</div>
                    <div><strong>Score:</strong> <span style="color: ${(result.Score || result.score) >= 0 ? '#27ae60' : '#e74c3c'}; font-weight: 700; font-size: 1.2rem;">${parseFloat(result.Score || result.score || 0).toFixed(2)}</span></div>
                </div>
                <div style="max-height: 500px; overflow-y: auto;">
            `;

            // Check if userAnswers is in the new detailed format (array of objects)
            const isDetailedFormat = userAnswers.length > 0 && typeof userAnswers[0] === 'object' && userAnswers[0] !== null;

            if (isDetailedFormat) {
                // New format: detailed answer objects with userAnswer, correctAnswer, isCorrect, etc.
                userAnswers.forEach((answer, index) => {
                    const isCorrect = answer.isCorrect;
                    const userAnswered = answer.userAnswer !== 'Not Answered';
                    const userAnswerLetter = answer.userAnswer;
                    const correctAnswerLetter = answer.correctAnswer;

                    html += `
                        <div style="background: ${isCorrect ? '#e8f5e9' : (userAnswered ? '#ffebee' : '#f5f5f5')}; border-left: 4px solid ${isCorrect ? '#27ae60' : (userAnswered ? '#e74c3c' : '#95a5a6')}; padding: 15px; margin-bottom: 15px; border-radius: 5px;">
                            <div style="font-weight: 600; margin-bottom: 8px; color: var(--secondary);">Question ${index + 1} (${answer.questionId} - ${answer.subject})</div>
                            <div style="margin-bottom: 12px; font-size: 1.05rem;">${answer.question}</div>

                            <div style="margin-bottom: 12px;">
                                <div style="margin: 5px 0; padding: 8px; background: ${userAnswerLetter === 'A' ? (isCorrect ? '#c8e6c9' : '#ffcdd2') : '#f9f9f9'}; border-radius: 4px;">
                                    <strong>A:</strong> ${answer.optionA} ${userAnswerLetter === 'A' ? 'üëâ <span style="color: #2196f3; font-weight: 600;">(User Answer)</span>' : ''} ${correctAnswerLetter === 'A' ? '‚úÖ <span style="color: #27ae60; font-weight: 600;">(Correct)</span>' : ''}
                                </div>
                                <div style="margin: 5px 0; padding: 8px; background: ${userAnswerLetter === 'B' ? (isCorrect ? '#c8e6c9' : '#ffcdd2') : '#f9f9f9'}; border-radius: 4px;">
                                    <strong>B:</strong> ${answer.optionB} ${userAnswerLetter === 'B' ? 'üëâ <span style="color: #2196f3; font-weight: 600;">(User Answer)</span>' : ''} ${correctAnswerLetter === 'B' ? '‚úÖ <span style="color: #27ae60; font-weight: 600;">(Correct)</span>' : ''}
                                </div>
                                <div style="margin: 5px 0; padding: 8px; background: ${userAnswerLetter === 'C' ? (isCorrect ? '#c8e6c9' : '#ffcdd2') : '#f9f9f9'}; border-radius: 4px;">
                                    <strong>C:</strong> ${answer.optionC} ${userAnswerLetter === 'C' ? 'üëâ <span style="color: #2196f3; font-weight: 600;">(User Answer)</span>' : ''} ${correctAnswerLetter === 'C' ? '‚úÖ <span style="color: #27ae60; font-weight: 600;">(Correct)</span>' : ''}
                                </div>
                                <div style="margin: 5px 0; padding: 8px; background: ${userAnswerLetter === 'D' ? (isCorrect ? '#c8e6c9' : '#ffcdd2') : '#f9f9f9'}; border-radius: 4px;">
                                    <strong>D:</strong> ${answer.optionD} ${userAnswerLetter === 'D' ? 'üëâ <span style="color: #2196f3; font-weight: 600;">(User Answer)</span>' : ''} ${correctAnswerLetter === 'D' ? '‚úÖ <span style="color: #27ae60; font-weight: 600;">(Correct)</span>' : ''}
                                </div>
                            </div>

                            <div style="font-weight: 600; font-size: 1.1rem;">
                                ${isCorrect ? '‚úÖ Correct (+1)' : (userAnswered ? '‚ùå Incorrect (-0.25)' : '‚ö™ Not Answered (0)')}
                            </div>
                        </div>
                    `;
                });
            } else {
                // Legacy format: array of answer indices
                examQuestions.forEach((q, index) => {
                    const userAnswerIndex = userAnswers[index];
                    const userAnswerLetter = userAnswerIndex !== null && userAnswerIndex !== undefined ? String.fromCharCode(65 + userAnswerIndex) : 'Not Answered';
                    const correctAnswerLetter = q.Correct;
                    const isCorrect = userAnswerLetter === correctAnswerLetter;
                    const userAnswerText = userAnswerIndex !== null && userAnswerIndex !== undefined ? q[`Option ${userAnswerLetter}`] : 'Not Answered';
                    const correctAnswerText = q[`Option ${correctAnswerLetter}`];

                    html += `
                        <div style="background: ${isCorrect ? '#e8f5e9' : (userAnswerIndex !== null ? '#ffebee' : '#f5f5f5')}; border-left: 4px solid ${isCorrect ? '#27ae60' : (userAnswerIndex !== null ? '#e74c3c' : '#95a5a6')}; padding: 15px; margin-bottom: 15px; border-radius: 5px;">
                            <div style="font-weight: 600; margin-bottom: 8px; color: var(--secondary);">Question ${index + 1} (${q.ID} - ${q.Subject})</div>
                            <div style="margin-bottom: 12px; font-size: 1.05rem;">${q.Question}</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                                <div>
                                    <strong>Your Answer:</strong>
                                    <span style="color: ${isCorrect ? '#27ae60' : (userAnswerIndex !== null ? '#e74c3c' : '#7f8c8d')}; font-weight: 600;">
                                        ${userAnswerLetter}${userAnswerIndex !== null && userAnswerIndex !== undefined ? ' - ' + userAnswerText : ''}
                                    </span>
                                </div>
                                <div>
                                    <strong>Correct Answer:</strong>
                                    <span style="color: #27ae60; font-weight: 600;">
                                        ${correctAnswerLetter} - ${correctAnswerText}
                                    </span>
                                </div>
                            </div>
                            <div style="font-weight: 600; font-size: 1.1rem;">
                                ${isCorrect ? '‚úÖ Correct (+1)' : (userAnswerIndex !== null ? '‚ùå Incorrect (-0.25)' : '‚ö™ Not Answered (0)')}
                            </div>
                        </div>
                    `;
                });
            }

            html += '</div>';
            content.innerHTML = html;
            modal.style.display = 'block';

            // Close modal handler
            document.getElementById('close-detailed-modal').onclick = function() {
                modal.style.display = 'none';
            };
        }

        // Show upload screen
        document.getElementById('upload-btn').addEventListener('click', function() {
            document.getElementById('question-bank-section').classList.add('hidden');
            document.getElementById('create-exam-section').classList.add('hidden');
            document.getElementById('view-results-section').classList.add('hidden');
            document.getElementById('upload-section').classList.remove('hidden');
            document.getElementById('ai-generator-section').classList.add('hidden');
        });

        // Capture photo with camera button
        document.getElementById('capture-photo-btn').addEventListener('click', function() {
            const cameraInput = document.getElementById('paper-upload');
            cameraInput.click();
        });

        // Choose file button
        document.getElementById('choose-file-btn').addEventListener('click', function() {
            const fileInput = document.getElementById('paper-upload-file');
            fileInput.click();
        });

        // Handle file selection from camera
        document.getElementById('paper-upload').addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                const fileName = e.target.files[0].name;
                document.getElementById('selected-file-info').classList.remove('hidden');
                document.getElementById('file-name').textContent = fileName;
            }
        });

        // Handle file selection from file browser
        document.getElementById('paper-upload-file').addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                const fileName = e.target.files[0].name;
                // Copy the selected file to the main input
                const mainInput = document.getElementById('paper-upload');
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(e.target.files[0]);
                mainInput.files = dataTransfer.files;

                document.getElementById('selected-file-info').classList.remove('hidden');
                document.getElementById('file-name').textContent = fileName;
            }
        });

        // Process upload with Gemini Vision API
        document.getElementById('process-upload-btn').addEventListener('click', async function() {
            const fileInput = document.getElementById('paper-upload');

            if (!fileInput || !fileInput.files[0]) {
                if (window.PoliteCCAPI && window.PoliteCCAPI.showNotification) {
                    window.PoliteCCAPI.showNotification('‚ùå Please select a file to upload.', 'error');
                }
                return;
            }

            const file = fileInput.files[0];
            const ocrProgress = document.getElementById('ocr-progress');
            const ocrProgressBar = document.getElementById('ocr-progress-bar');
            const ocrStatus = document.getElementById('ocr-status');

            // Show progress
            ocrProgress.classList.remove('hidden');
            ocrProgressBar.style.width = '30%';
            ocrStatus.textContent = 'Reading image...';

            try {
                // Convert file to base64
                const reader = new FileReader();
                reader.onload = async function(e) {
                    ocrProgressBar.style.width = '60%';
                    ocrStatus.textContent = 'Extracting questions with Gemini AI...';

                    try {
                        // Call backend API
                        const response = await fetch(`${API_URL}/gemini/extract-questions`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                imageData: {
                                    base64: e.target.result,
                                    mimeType: file.type
                                }
                            })
                        });

                        const data = await response.json();

                        if (!data.success) {
                            throw new Error(data.error || 'Failed to extract questions');
                        }

                        ocrProgressBar.style.width = '100%';
                        ocrStatus.textContent = 'Extraction complete!';

                        // Hide progress after a brief delay
                        setTimeout(() => {
                            ocrProgress.classList.add('hidden');
                        }, 500);

                        // Store extracted questions
                        extractedQuestions = data.data.questions.map((q, index) => ({
                            id: `Q${Date.now()}_${index}`,
                            subject: q.subject || 'Others',
                            question: q.question,
                            options: [q.optionA, q.optionB, q.optionC, q.optionD],
                            correct: ['A', 'B', 'C', 'D'].indexOf(q.correct.toUpperCase())
                        }));

                        // Display extracted questions directly
                        const readyQuestions = document.getElementById('ready-questions');
                        if (readyQuestions) {
                            if (extractedQuestions.length === 0) {
                                readyQuestions.innerHTML = '<p style="text-align: center; color: var(--danger);">‚ùå No valid questions found.</p>';
                            } else {
                                let html = '<div style="max-height: 400px; overflow-y: auto;">';
                                extractedQuestions.forEach((q, index) => {
                                    html += `
                                    <label class="extracted-question-item" style="display: flex; align-items: flex-start; background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 12px; border-left: 3px solid var(--secondary); cursor: pointer; transition: all 0.2s;">
                                        <input type="checkbox" class="extracted-question-checkbox" value="${index}" checked style="margin-right: 12px; margin-top: 4px; width: 18px; height: 18px; cursor: pointer; flex-shrink: 0;">
                                        <div style="flex: 1;">
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                                <span class="question-tag">${q.subject}</span>
                                            </div>
                                            <p style="margin-bottom: 10px; font-weight: 500;">${q.question}</p>
                                            <div style="margin-left: 25px; margin-bottom: 8px;">
                                                <div>A) ${q.options[0]}</div>
                                                <div>B) ${q.options[1]}</div>
                                                <div>C) ${q.options[2]}</div>
                                                <div>D) ${q.options[3]}</div>
                                            </div>
                                            <div style="color: var(--success); font-weight: 500;">
                                                ‚úì Correct Answer: ${String.fromCharCode(65 + q.correct)}
                                            </div>
                                        </div>
                                    </label>
                                    `;
                                });
                                html += '</div>';
                                readyQuestions.innerHTML = html;

                                // Add hover effects
                                document.querySelectorAll('.extracted-question-item').forEach(item => {
                                    item.addEventListener('mouseenter', function() {
                                        this.style.background = '#e8f4fd';
                                    });
                                    item.addEventListener('mouseleave', function() {
                                        this.style.background = '#f8f9fa';
                                    });
                                });
                            }
                        }

                        const uploadResultContainer = document.getElementById('upload-result-container');
                        if (uploadResultContainer) {
                            uploadResultContainer.classList.remove('hidden');
                        }

                        // Hide the raw text area since we're showing questions directly
                        const extractedText = document.getElementById('extracted-text');
                        const cleanTextBtn = document.getElementById('clean-text-btn');
                        if (extractedText) extractedText.style.display = 'none';
                        if (cleanTextBtn) cleanTextBtn.style.display = 'none';

                        if (window.PoliteCCAPI && window.PoliteCCAPI.showNotification) {
                            window.PoliteCCAPI.showNotification(`‚úÖ Extracted ${extractedQuestions.length} questions successfully!`, 'success');
                        }

                    } catch (error) {
                        console.error('Gemini extraction error:', error);
                        ocrProgress.classList.add('hidden');

                        if (window.PoliteCCAPI && window.PoliteCCAPI.showNotification) {
                            window.PoliteCCAPI.showNotification(`‚ùå Failed to extract questions: ${error.message}`, 'error');
                        }
                    }
                };

                reader.onerror = function() {
                    ocrProgress.classList.add('hidden');
                    if (window.PoliteCCAPI && window.PoliteCCAPI.showNotification) {
                        window.PoliteCCAPI.showNotification('‚ùå Failed to read file', 'error');
                    }
                };

                reader.readAsDataURL(file);

            } catch (error) {
                console.error('OCR Error:', error);
                ocrProgress.classList.add('hidden');

                if (window.PoliteCCAPI && window.PoliteCCAPI.showNotification) {
                    window.PoliteCCAPI.showNotification(`‚ùå OCR failed: ${error.message}`, 'error');
                }
            }
        });

        // Clean text
        document.getElementById('clean-text-btn').addEventListener('click', function() {
            const extractedText = document.getElementById('extracted-text');
            if (!extractedText) return;
            
            const rawText = extractedText.value;
            extractedQuestions = [];
            
            // Simple text cleaning and parsing
            const questionBlocks = rawText.split(/\n\s*\n/).filter(block => block.trim() !== '');
            
            questionBlocks.forEach((block, index) => {
                // Extract question number and text
                const lines = block.split('\n').filter(line => line.trim() !== '');
                if (lines.length < 6) return;
                
                const questionLine = lines[0].replace(/^\d+\.\s*/, '').trim();
                const options = lines.slice(1, 5).map(line => line.replace(/^[A-D]\)\s*/, '').trim());
                const answerLine = lines[5] || '';
                const correctAns = answerLine.match(/Answer:\s*([A-D])/i)?.[1] || 'A';
                
                const question = {
                    id: `Q${Date.now()}_${index}`,
                    subject: 'Others',
                    question: questionLine,
                    options: options,
                    correct: ['A', 'B', 'C', 'D'].indexOf(correctAns)
                };
                
                extractedQuestions.push(question);
            });
            
            // Display questions with checkboxes for selection
            const readyQuestions = document.getElementById('ready-questions');
            if (readyQuestions) {
                if (extractedQuestions.length === 0) {
                    readyQuestions.innerHTML = '<p style="text-align: center; color: var(--danger);">‚ùå No valid questions found.</p>';
                } else {
                    let html = '<div style="max-height: 400px; overflow-y: auto;">';
                    extractedQuestions.forEach((q, index) => {
                        html += `
                        <label class="extracted-question-item" style="display: flex; align-items: flex-start; background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 12px; border-left: 3px solid var(--secondary); cursor: pointer; transition: all 0.2s;">
                            <input type="checkbox" class="extracted-question-checkbox" value="${index}" checked style="margin-right: 12px; margin-top: 4px; width: 18px; height: 18px; cursor: pointer; flex-shrink: 0;">
                            <div style="flex: 1;">
                                <p style="margin-bottom: 10px; font-weight: 500;">${q.question}</p>
                                <div style="margin-left: 25px; margin-bottom: 8px;">
                                    <div>A) ${q.options[0]}</div>
                                    <div>B) ${q.options[1]}</div>
                                    <div>C) ${q.options[2]}</div>
                                    <div>D) ${q.options[3]}</div>
                                </div>
                                <div style="color: var(--success); font-weight: 500;">
                                    Correct Answer: ${String.fromCharCode(65 + q.correct)}
                                </div>
                            </div>
                        </label>
                        `;
                    });
                    html += '</div>';
                    readyQuestions.innerHTML = html;

                    // Add hover effects
                    document.querySelectorAll('.extracted-question-item').forEach(item => {
                        item.addEventListener('mouseenter', function() {
                            this.style.background = '#e8f4fd';
                        });
                        item.addEventListener('mouseleave', function() {
                            this.style.background = '#f8f9fa';
                        });
                    });
                }
            }
            
            const notification = document.createElement('div');
            notification.className = 'notification success';
            notification.innerHTML = `‚úÖ ${extractedQuestions.length} questions parsed successfully!`;
            document.getElementById('notification-container').appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        });

        // Add all extracted questions to database
        document.getElementById('add-extracted-btn').addEventListener('click', async function() {
            if (extractedQuestions.length === 0) {
                if (window.PoliteCCAPI && window.PoliteCCAPI.showNotification) {
                    window.PoliteCCAPI.showNotification('‚ùå No questions to add.', 'error');
                }
                return;
            }

            // Add questions to database
            let successCount = 0;
            for (const q of extractedQuestions) {
                const success = await window.PoliteCCAPI.addQuestionToDatabase({
                    subject: q.subject,
                    question: q.question,
                    optionA: q.options[0],
                    optionB: q.options[1],
                    optionC: q.options[2],
                    optionD: q.options[3],
                    correct: String.fromCharCode(65 + q.correct)
                });

                if (success) successCount++;
            }

            // Hide upload result and show question bank
            const uploadResultContainer = document.getElementById('upload-result-container');
            if (uploadResultContainer) {
                uploadResultContainer.classList.add('hidden');
            }

            if (window.PoliteCCAPI && window.PoliteCCAPI.showNotification) {
                window.PoliteCCAPI.showNotification(`‚úÖ ${successCount} questions added to bank!`, 'success');
            }

            // Refresh question bank
            document.getElementById('question-bank-btn').click();
        });

        // Add selected extracted questions to database
        document.getElementById('add-selected-btn').addEventListener('click', async function() {
            if (extractedQuestions.length === 0) {
                if (window.PoliteCCAPI && window.PoliteCCAPI.showNotification) {
                    window.PoliteCCAPI.showNotification('‚ùå No questions to add.', 'error');
                }
                return;
            }

            // Get selected checkboxes
            const selectedCheckboxes = document.querySelectorAll('.extracted-question-checkbox:checked');

            if (selectedCheckboxes.length === 0) {
                if (window.PoliteCCAPI && window.PoliteCCAPI.showNotification) {
                    window.PoliteCCAPI.showNotification('‚ùå No questions selected. Please select at least one question.', 'error');
                }
                return;
            }

            // Add selected questions to database
            let successCount = 0;
            for (const checkbox of selectedCheckboxes) {
                const index = parseInt(checkbox.value);
                const q = extractedQuestions[index];

                const success = await window.PoliteCCAPI.addQuestionToDatabase({
                    subject: q.subject,
                    question: q.question,
                    optionA: q.options[0],
                    optionB: q.options[1],
                    optionC: q.options[2],
                    optionD: q.options[3],
                    correct: String.fromCharCode(65 + q.correct)
                });

                if (success) successCount++;
            }

            // Hide upload result and show question bank
            const uploadResultContainer = document.getElementById('upload-result-container');
            if (uploadResultContainer) {
                uploadResultContainer.classList.add('hidden');
            }

            if (window.PoliteCCAPI && window.PoliteCCAPI.showNotification) {
                window.PoliteCCAPI.showNotification(`‚úÖ ${successCount} selected questions added to bank!`, 'success');
            }

            // Refresh question bank
            document.getElementById('question-bank-btn').click();
        });

        // Show AI generator
        document.getElementById('ai-btn').addEventListener('click', function() {
            document.getElementById('question-bank-section').classList.add('hidden');
            document.getElementById('create-exam-section').classList.add('hidden');
            document.getElementById('view-results-section').classList.add('hidden');
            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('ai-generator-section').classList.remove('hidden');
        });

        // Generate AI question with real Gemini API
        document.getElementById('generate-ai-btn').addEventListener('click', async function() {
            const subject = document.getElementById('ai-subject').value;
            const difficulty = document.getElementById('ai-difficulty').value;
            const customPrompt = document.getElementById('ai-custom-prompt').value.trim();

            // Show processing notification
            if (window.PoliteCCAPI && window.PoliteCCAPI.showNotification) {
                window.PoliteCCAPI.showNotification('ü§ñ AI is generating your question...', 'info');
            }

            // Disable button during generation
            const generateBtn = document.getElementById('generate-ai-btn');
            generateBtn.disabled = true;
            generateBtn.textContent = '‚è≥ Generating...';

            try {
                // Call backend API
                const response = await fetch(`${API_URL}/gemini/generate-question`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        subject: subject,
                        difficulty: difficulty,
                        customPrompt: customPrompt
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to generate question');
                }

                const qData = data.data;

                // Display the question
                document.getElementById('ai-question-text').textContent = qData.question;
                document.getElementById('ai-option-a').textContent = qData.optionA;
                document.getElementById('ai-option-b').textContent = qData.optionB;
                document.getElementById('ai-option-c').textContent = qData.optionC;
                document.getElementById('ai-option-d').textContent = qData.optionD;
                document.getElementById('ai-correct-answer').textContent = qData.correct;
                document.getElementById('ai-explanation').textContent = qData.explanation;
                document.getElementById('ai-display-subject').textContent = qData.subject;
                document.getElementById('ai-display-difficulty').textContent = qData.difficulty.toUpperCase();

                aiGeneratedQuestion = {
                    subject: qData.subject,
                    question: qData.question,
                    options: [qData.optionA, qData.optionB, qData.optionC, qData.optionD],
                    correct: ['A', 'B', 'C', 'D'].indexOf(qData.correct.toUpperCase()),
                    difficulty: qData.difficulty
                };

                document.getElementById('ai-result-container').classList.remove('hidden');

                if (window.PoliteCCAPI && window.PoliteCCAPI.showNotification) {
                    window.PoliteCCAPI.showNotification('‚úÖ AI question generated successfully!', 'success');
                }

            } catch (error) {
                console.error('AI generation error:', error);
                if (window.PoliteCCAPI && window.PoliteCCAPI.showNotification) {
                    window.PoliteCCAPI.showNotification(`‚ùå Failed to generate question: ${error.message}`, 'error');
                }
            } finally {
                // Re-enable button
                generateBtn.disabled = false;
                generateBtn.textContent = '‚ú® Generate Question with AI';
            }
        });

        // Accept AI question and add to database
        document.getElementById('accept-ai-btn').addEventListener('click', async function() {
            if (!aiGeneratedQuestion) return;

            // Disable button during save
            const acceptBtn = document.getElementById('accept-ai-btn');
            acceptBtn.disabled = true;
            acceptBtn.textContent = '‚è≥ Saving...';

            try {
                // Add to database
                const success = await window.PoliteCCAPI.addQuestionToDatabase({
                    subject: aiGeneratedQuestion.subject,
                    question: aiGeneratedQuestion.question,
                    optionA: aiGeneratedQuestion.options[0],
                    optionB: aiGeneratedQuestion.options[1],
                    optionC: aiGeneratedQuestion.options[2],
                    optionD: aiGeneratedQuestion.options[3],
                    correct: String.fromCharCode(65 + aiGeneratedQuestion.correct)
                });

                if (success) {
                    // Clear AI section
                    aiGeneratedQuestion = null;
                    document.getElementById('ai-result-container').classList.add('hidden');
                    document.getElementById('ai-custom-prompt').value = '';

                    // Show success message
                    if (window.PoliteCCAPI && window.PoliteCCAPI.showNotification) {
                        window.PoliteCCAPI.showNotification('‚úÖ AI question added to your bank!', 'success');
                    }

                    // Optionally go back to question bank
                    // document.getElementById('question-bank-btn').click();
                }

            } catch (error) {
                console.error('Error accepting AI question:', error);
                if (window.PoliteCCAPI && window.PoliteCCAPI.showNotification) {
                    window.PoliteCCAPI.showNotification(`‚ùå Failed to save question: ${error.message}`, 'error');
                }
            } finally {
                // Re-enable button
                acceptBtn.disabled = false;
                acceptBtn.textContent = '‚úÖ Accept & Add to Bank';
            }
        });

        // Regenerate AI question
        document.getElementById('regenerate-ai-btn').addEventListener('click', function() {
            document.getElementById('generate-ai-btn').click();
        });


        // Start exam
        document.getElementById('start-exam-btn').addEventListener('click', async function() {
            const examCode = document.getElementById('exam-code-input').value.trim();
            const name = document.getElementById('candidate-name').value.trim();
            const mobile = document.getElementById('candidate-mobile').value.trim();

            if (!examCode || !name || !mobile) {
                const loginError = document.getElementById('login-error');
                if (loginError) {
                    loginError.textContent = '‚ùå Exam code, name, and mobile number are required!';
                    setTimeout(() => {
                        loginError.textContent = '';
                    }, 3000);
                }
                return;
            }

            // Validate mobile number (should be 10 digits)
            if (!/^\d{10}$/.test(mobile)) {
                const loginError = document.getElementById('login-error');
                if (loginError) {
                    loginError.textContent = '‚ùå Please enter a valid 10-digit mobile number!';
                    setTimeout(() => {
                        loginError.textContent = '';
                    }, 3000);
                }
                return;
            }

            // Load exams and questions from API if not already loaded
            if (exams.length === 0 && window.PoliteCCAPI && window.PoliteCCAPI.loadExams) {
                const loginError = document.getElementById('login-error');
                if (loginError) loginError.textContent = 'üîÑ Loading exam data...';

                exams = await window.PoliteCCAPI.loadExams() || [];
                questions = await window.PoliteCCAPI.loadQuestions() || [];

                if (loginError) loginError.textContent = '';
            }

            // Find exam (case-insensitive comparison)
            const exam = exams.find(e => (e['Exam Code'] || '').toUpperCase() === examCode.toUpperCase());

            if (!exam) {
                const loginError = document.getElementById('login-error');
                if (loginError) {
                    loginError.textContent = '‚ùå Invalid exam code!';
                    setTimeout(() => {
                        loginError.textContent = '';
                    }, 3000);
                }
                return;
            }

            // Check if exam has expired
            if (exam['Expiry (IST)']) {
                const expiryDate = new Date(exam['Expiry (IST)']);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                expiryDate.setHours(0, 0, 0, 0);

                if (expiryDate.getTime() < today.getTime()) {
                    const loginError = document.getElementById('login-error');
                    if (loginError) {
                        loginError.textContent = '‚ùå This exam has expired! Only admin can view results.';
                        setTimeout(() => {
                            loginError.textContent = '';
                        }, 5000);
                    }
                    return;
                }
            }
            
            // Get questions for this exam
            // Handle Question IDs - can be an array of record IDs or comma-separated string of question IDs (for backward compatibility)
            let questionIds = exam['Question IDs'] || exam['Questions'] || exam.questionIds || exam.QuestionIDs || exam.question_ids || '';
            if (typeof questionIds === 'string') {
                questionIds = questionIds.split(',').map(id => id.trim());
            }
            // Find questions by Airtable record ID (new format) or by Question ID field (old format)
            const examQuestions = questionIds
                .map(id => questions.find(q => q.id === id || q.ID === id))
                .filter(q => q);
            
            if (examQuestions.length === 0) {
                const loginError = document.getElementById('login-error');
                if (loginError) {
                    loginError.textContent = '‚ùå No questions found for this exam!';
                    setTimeout(() => {
                        loginError.textContent = '';
                    }, 3000);
                }
                return;
            }
            
            // Prepare exam data
            currentExam = {
                code: exam['Exam Code'],  // Use actual exam code from database
                examId: exam.id,  // Store the Airtable record ID for linking
                title: exam.Title,
                duration: parseInt(exam['Duration (mins)']) || 60,
                questions: examQuestions,
                startTime: new Date()
            };
            
            // Initialize answers array
            userAnswers = new Array(examQuestions.length).fill(null);
            currentQuestionIndex = 0;
            
            // Start timer
            timeRemaining = currentExam.duration * 60;
            startTime = new Date();
            startTimer();
            
            // Show exam screen
            document.getElementById('candidate-login-screen').classList.remove('active');
            document.getElementById('exam-screen').classList.add('active');
            
            loadQuestion();
            
            const notification = document.createElement('div');
            notification.className = 'notification success';
            notification.innerHTML = '‚úÖ Exam started successfully!';
            document.getElementById('notification-container').appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        });

        // Option selection
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('option')) {
                const optionIndex = parseInt(e.target.getAttribute('data-index'));
                selectOption(optionIndex);
            }
        });

        function selectOption(index) {
            userAnswers[currentQuestionIndex] = index;
            const options = document.querySelectorAll('.option');
            options.forEach((option, i) => {
                if (i === index) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
        }

        // Previous question
        document.getElementById('prev-btn').addEventListener('click', function() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        });

        // Next question
        document.getElementById('next-btn').addEventListener('click', function() {
            if (currentQuestionIndex < currentExam.questions.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
            }
        });

        // Submit exam
        document.getElementById('submit-btn').addEventListener('click', function() {
            submitExam();
        });

        // View candidate's own detailed results
        document.getElementById('view-my-answers-btn').addEventListener('click', function() {
            if (!candidateDetailedAnswers) {
                window.PoliteCCAPI.showNotification('‚ùå No results available to display', 'error');
                return;
            }
            showCandidateDetailedResults();
        });

        // Function to show candidate's detailed results
        function showCandidateDetailedResults() {
            const modal = document.getElementById('detailed-result-modal');
            const content = document.getElementById('detailed-result-content');

            const data = candidateDetailedAnswers;

            // Build detailed view
            let html = `
                <h3 style="color: var(--secondary); margin-bottom: 20px;">Your Detailed Results</h3>
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; flex-wrap: wrap; gap: 15px;">
                    <div><strong>Name:</strong> ${data.candidateName}</div>
                    <div><strong>Exam:</strong> ${data.examCode}</div>
                    <div><strong>Score:</strong> <span style="color: ${data.score >= 0 ? '#27ae60' : '#e74c3c'}; font-weight: 700; font-size: 1.2rem;">${data.score}</span></div>
                </div>
                <div style="max-height: 500px; overflow-y: auto;">
            `;

            data.answers.forEach((answer, index) => {
                const isCorrect = answer.isCorrect;
                const userAnswered = answer.userAnswer !== 'Not Answered';

                html += `
                    <div style="background: ${isCorrect ? '#e8f5e9' : (userAnswered ? '#ffebee' : '#f5f5f5')}; border-left: 4px solid ${isCorrect ? '#27ae60' : (userAnswered ? '#e74c3c' : '#95a5a6')}; padding: 15px; margin-bottom: 15px; border-radius: 5px;">
                        <div style="font-weight: 600; margin-bottom: 8px; color: var(--secondary);">Question ${index + 1} (${answer.questionId} - ${answer.subject})</div>
                        <div style="margin-bottom: 12px; font-size: 1.05rem;">${answer.question}</div>

                        <div style="margin-bottom: 12px;">
                            <div style="margin: 5px 0; padding: 8px; background: ${answer.userAnswer === 'A' ? (isCorrect ? '#c8e6c9' : '#ffcdd2') : '#f9f9f9'}; border-radius: 4px;">
                                <strong>A:</strong> ${answer.optionA} ${answer.userAnswer === 'A' ? 'üëâ <span style="color: #2196f3; font-weight: 600;">(Your Answer)</span>' : ''} ${answer.correctAnswer === 'A' ? '‚úÖ <span style="color: #27ae60; font-weight: 600;">(Correct)</span>' : ''}
                            </div>
                            <div style="margin: 5px 0; padding: 8px; background: ${answer.userAnswer === 'B' ? (isCorrect ? '#c8e6c9' : '#ffcdd2') : '#f9f9f9'}; border-radius: 4px;">
                                <strong>B:</strong> ${answer.optionB} ${answer.userAnswer === 'B' ? 'üëâ <span style="color: #2196f3; font-weight: 600;">(Your Answer)</span>' : ''} ${answer.correctAnswer === 'B' ? '‚úÖ <span style="color: #27ae60; font-weight: 600;">(Correct)</span>' : ''}
                            </div>
                            <div style="margin: 5px 0; padding: 8px; background: ${answer.userAnswer === 'C' ? (isCorrect ? '#c8e6c9' : '#ffcdd2') : '#f9f9f9'}; border-radius: 4px;">
                                <strong>C:</strong> ${answer.optionC} ${answer.userAnswer === 'C' ? 'üëâ <span style="color: #2196f3; font-weight: 600;">(Your Answer)</span>' : ''} ${answer.correctAnswer === 'C' ? '‚úÖ <span style="color: #27ae60; font-weight: 600;">(Correct)</span>' : ''}
                            </div>
                            <div style="margin: 5px 0; padding: 8px; background: ${answer.userAnswer === 'D' ? (isCorrect ? '#c8e6c9' : '#ffcdd2') : '#f9f9f9'}; border-radius: 4px;">
                                <strong>D:</strong> ${answer.optionD} ${answer.userAnswer === 'D' ? 'üëâ <span style="color: #2196f3; font-weight: 600;">(Your Answer)</span>' : ''} ${answer.correctAnswer === 'D' ? '‚úÖ <span style="color: #27ae60; font-weight: 600;">(Correct)</span>' : ''}
                            </div>
                        </div>

                        <div style="font-weight: 600; font-size: 1.1rem;">
                            ${isCorrect ? '‚úÖ Correct (+1 point)' : (userAnswered ? '‚ùå Incorrect (-0.25 points)' : '‚ö™ Not Answered (0 points)')}
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            content.innerHTML = html;
            modal.style.display = 'block';

            // Close modal handler
            document.getElementById('close-detailed-modal').onclick = function() {
                modal.style.display = 'none';
            };
        }

        // Restart app
        document.getElementById('restart-btn').addEventListener('click', function() {
            document.getElementById('result-screen').classList.remove('active');
            document.getElementById('admin-login-screen').classList.add('active');

            // Reset candidate detailed answers
            candidateDetailedAnswers = null;

            const notification = document.createElement('div');
            notification.className = 'notification success';
            notification.innerHTML = '‚úÖ Ready for next exam!';
            document.getElementById('notification-container').appendChild(notification);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        });

        // Timer functions
        function startTimer() {
            updateTimerDisplay();
            
            examTimer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(examTimer);
                    autoSubmitExam();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timer-display').textContent = 
                `‚è±Ô∏è Time Remaining: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function autoSubmitExam() {
            const notification = document.createElement('div');
            notification.className = 'notification info';
            notification.innerHTML = '‚è∞ Time is up! Exam submitted automatically.';
            document.getElementById('notification-container').appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
            
            submitExam(true);
        }

        async function submitExam(isAutoSubmit = false) {
            clearInterval(examTimer);

            // Calculate score and prepare detailed answers
            let score = 0;
            const detailedAnswers = [];

            currentExam.questions.forEach((question, index) => {
                const userAnswer = userAnswers[index];
                const correctAnswerIndex = question.Correct.charCodeAt(0) - 65;
                const isCorrect = (userAnswer === correctAnswerIndex);

                if (userAnswer !== null) {
                    score += isCorrect ? 1 : -0.25;
                }

                // Store detailed answer info
                detailedAnswers.push({
                    questionId: question.ID,
                    subject: question.Subject,
                    question: question.Question,
                    optionA: question['Option A'],
                    optionB: question['Option B'],
                    optionC: question['Option C'],
                    optionD: question['Option D'],
                    userAnswer: userAnswer !== null ? ['A', 'B', 'C', 'D'][userAnswer] : 'Not Answered',
                    correctAnswer: question.Correct,
                    isCorrect: isCorrect,
                    points: userAnswer !== null ? (isCorrect ? 1 : -0.25) : 0
                });
            });

            // Get candidate info (both are now mandatory)
            const candidateName = document.getElementById('candidate-name').value.trim();
            const candidateMobile = document.getElementById('candidate-mobile').value.trim();

            // Save result to database if API is available
            if (window.PoliteCCAPI && window.PoliteCCAPI.submitResultToDatabase) {
                // Check for duplicate submission (same name + mobile for this exam)
                const existingResults = await window.PoliteCCAPI.getExamResults(currentExam.code) || [];
                const duplicate = existingResults.find(r =>
                    (r.Name === candidateName && r.Mobile === candidateMobile)
                );

                if (duplicate) {
                    window.PoliteCCAPI.showNotification('‚ö†Ô∏è You have already submitted this exam!', 'error');
                    return; // Prevent submission
                } else {
                    const resultData = {
                        'Name': candidateName,
                        'Mobile': candidateMobile,
                        'Score': parseFloat(score.toFixed(2)),
                        'Answers': JSON.stringify(detailedAnswers),
                        'Exam Code': currentExam.code  // Always include exam code for reference
                    };

                    // Only add Exam linked record field if examId is valid
                    if (currentExam.examId) {
                        resultData['Exam'] = [currentExam.examId];
                    }

                    const submitted = await window.PoliteCCAPI.submitResultToDatabase(resultData);
                    if (!submitted) {
                        window.PoliteCCAPI.showNotification('‚ùå Failed to submit exam. Please try again.', 'error');
                        return; // Don't show result screen if submission failed
                    }
                }
            }

            // Store detailed answers for candidate viewing
            candidateDetailedAnswers = {
                candidateName: candidateName,
                candidateMobile: candidateMobile,
                examCode: currentExam.code,
                examTitle: currentExam.title,
                score: parseFloat(score.toFixed(2)),
                answers: detailedAnswers
            };

            // Show result screen
            document.getElementById('exam-screen').classList.remove('active');
            document.getElementById('result-screen').classList.add('active');

            document.getElementById('final-score').textContent = score.toFixed(2);
            document.getElementById('result-exam-code').textContent = currentExam.code;
            document.getElementById('result-name').textContent = candidateName;
            document.getElementById('result-mobile').textContent = candidateMobile;

            const notification = document.createElement('div');
            notification.className = 'notification success';
            notification.innerHTML = `‚úÖ Exam submitted! Final score: ${score.toFixed(2)}`;
            document.getElementById('notification-container').appendChild(notification);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        // Question loading
        function loadQuestion() {
            if (!currentExam || currentQuestionIndex >= currentExam.questions.length) return;
            
            const question = currentExam.questions[currentQuestionIndex];
            
            // Update UI
            document.getElementById('current-q-num').textContent = currentQuestionIndex + 1;
            document.getElementById('total-questions').textContent = currentExam.questions.length;
            document.getElementById('progress-num').textContent = currentQuestionIndex + 1;
            document.getElementById('progress-total').textContent = currentExam.questions.length;
            document.getElementById('question-subject-display').textContent = question.Subject || 'Unknown';
            document.getElementById('question-text-display').textContent = question.Question || 'Loading question...';
            document.getElementById('option-a-display').textContent = question['Option A'] || 'Option A';
            document.getElementById('option-b-display').textContent = question['Option B'] || 'Option B';
            document.getElementById('option-c-display').textContent = question['Option C'] || 'Option C';
            document.getElementById('option-d-display').textContent = question['Option D'] || 'Option D';
            
            // Update selected option
            const options = document.querySelectorAll('.option');
            options.forEach((option, index) => {
                if (userAnswers[currentQuestionIndex] === index) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
            
            // Update navigation buttons
            document.getElementById('prev-btn').disabled = (currentQuestionIndex === 0);
            if (currentQuestionIndex === currentExam.questions.length - 1) {
                document.getElementById('next-btn').style.display = 'none';
                document.getElementById('submit-btn').style.display = 'block';
            } else {
                document.getElementById('next-btn').style.display = 'block';
                document.getElementById('submit-btn').style.display = 'none';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set default expiry date to tomorrow
            const now = new Date();
            now.setDate(now.getDate() + 1);
            const expiryInput = document.getElementById('exam-expiry');
            if (expiryInput) {
                // For date input, use .value with YYYY-MM-DD format
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                expiryInput.value = `${year}-${month}-${day}`;
            }
        });
    </script>
</body>
</html>
